{% extends 'base.html' %}

{% block title %}
    {% if form.instance.pk %}
        {% include 'alarms/includes/page_title.html' with page_title="Тревоги" subtitle="Редактирование" %}
    {% else %}
        {% include 'alarms/includes/page_title.html' with page_title="Тревоги" subtitle="Создание" %}
    {% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .required-field::after {
        content: " *";
        color: #dc3545;
        font-weight: bold;
    }
    
    .required-field {
        color: #495057;
        font-weight: 500;
    }
    
    .form-label.required-field {
        margin-bottom: 0.25rem;
    }
    
    .form-control:disabled {
        background-color: #f8f9fa !important;
        opacity: 0.6 !important;
        cursor: not-allowed !important;
        border-color: #dee2e6 !important;
    }
    
    .form-control:not(:disabled) {
        background-color: #fff !important;
        opacity: 1 !important;
        cursor: text !important;
    }
    
    .form-label.disabled {
        color: #6c757d;
        font-style: italic;
    }
    
    .field-hint {
        font-size: 0.875rem;
        margin-top: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
    }
    
    .field-hint.text-success {
        background-color: #d1e7dd;
        color: #0f5132;
        border: 1px solid #badbcc;
    }
    
    .field-hint.text-warning {
        background-color: #fff3cd;
        color: #664d03;
        border: 1px solid #ffecb5;
    }
</style>
{% endblock %}

{% block content %}
  {% if form.errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <ul class="mb-0">
        {% for field in form %}
          {% for error in field.errors %}
            <li>{{ field.label }}: {{ error }}</li>
          {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endif %}

  {% if messages %}
    {% for message in messages %}
      <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-exclamation-triangle"></i> 
        {% if form.instance.pk %}Редактирование{% else %}Создание{% endif %} тревоги
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'alarms:alarm_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Назад к списку
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-gear"></i> Настройки тревоги
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="alarmForm" novalidate>
                    {% csrf_token %}
                    
                    <div class="row">
                        <!-- Основные настройки -->
                        <div class="col-md-6">
                            <h6 class="mb-3">Основные настройки</h6>
                            
                            <div class="mb-3">
                                <label for="{{ form.alarm_class.id_for_label }}" class="form-label required-field">
                                    {{ form.alarm_class.label }}
                                </label>
                                <select name="{{ form.alarm_class.name }}" id="{{ form.alarm_class.id_for_label }}" class="form-control{% if form.alarm_class.errors %} is-invalid{% endif %}">
                                    {% for val, label in form.alarm_class.field.choices %}
                                        <option value="{{ val }}"{% if form.alarm_class.value == val %} selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                {% if form.alarm_class.errors %}
                                  <div class="invalid-feedback d-block">{{ form.alarm_class.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.table.id_for_label }}" class="form-label required-field">
                                    {{ form.table.label }}
                                </label>
                                <select name="{{ form.table.name }}" id="{{ form.table.id_for_label }}" class="form-control{% if form.table.errors %} is-invalid{% endif %}">
                                    {% for val, label in form.table.field.choices %}
                                        <option value="{{ val }}"{% if form.table.value == val %} selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                {% if form.table.errors %}
                                  <div class="invalid-feedback d-block">{{ form.table.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.logic.id_for_label }}" class="form-label required-field">
                                    {{ form.logic.label }}
                                </label>
                                <select name="{{ form.logic.name }}" id="{{ form.logic.id_for_label }}" class="form-control{% if form.logic.errors %} is-invalid{% endif %}">
                                    {% for val, label in form.logic.field.choices %}
                                        <option value="{{ val }}"{% if form.logic.value == val %} selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                {% if form.logic.errors %}
                                  <div class="invalid-feedback d-block">{{ form.logic.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3" id="channelField">
                                <label for="{{ form.channel.id_for_label }}" class="form-label required-field">
                                    {{ form.channel.label }}
                                </label>
                                <input type="text" name="{{ form.channel.name }}" id="{{ form.channel.id_for_label }}" class="form-control{% if form.channel.errors %} is-invalid{% endif %}" value="{{ form.channel.value|default_if_none:'' }}">
                                {% if form.channel.errors %}
                                  <div class="invalid-feedback d-block">{{ form.channel.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Дополнительные настройки -->
                        <div class="col-md-6">
                            <h6 class="mb-3">Дополнительные настройки</h6>
                            
                            <div class="mb-3" id="discreteValField">
                                <label for="{{ form.discrete_val.id_for_label }}" class="form-label required-field">
                                    {{ form.discrete_val.label }}
                                </label>
                                <input type="number" step="0.01" name="{{ form.discrete_val.name }}" id="{{ form.discrete_val.id_for_label }}" class="form-control{% if form.discrete_val.errors %} is-invalid{% endif %}" value="{{ form.discrete_val.value|default_if_none:'' }}">
                                {% if form.discrete_val.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.discrete_val.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3" id="limitTypeField">
                                <label for="{{ form.limit_type.id_for_label }}" class="form-label required-field">
                                    {{ form.limit_type.label }}
                                </label>
                                <select name="{{ form.limit_type.name }}" id="{{ form.limit_type.id_for_label }}" class="form-control{% if form.limit_type.errors %} is-invalid{% endif %}">
                                    {% for val, label in form.limit_type.field.choices %}
                                        <option value="{{ val }}"{% if form.limit_type.value == val %} selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                {% if form.limit_type.errors %}
                                  <div class="invalid-feedback d-block">{{ form.limit_type.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3" id="limitConfigTypeField">
                                <label for="{{ form.limit_config_type.id_for_label }}" class="form-label required-field">
                                    {{ form.limit_config_type.label }}
                                </label>
                                <select name="{{ form.limit_config_type.name }}" id="{{ form.limit_config_type.id_for_label }}" class="form-control{% if form.limit_config_type.errors %} is-invalid{% endif %}">
                                    {% for val, label in form.limit_config_type.field.choices %}
                                        <option value="{{ val }}"{% if form.limit_config_type.value == val %} selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                {% if form.limit_config_type.errors %}
                                  <div class="invalid-feedback d-block">{{ form.limit_config_type.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Настройки значений пределов -->
                            <div id="limitValuesSection">
                                <div class="mb-3" id="lowField">
                                    <label for="{{ form.low.id_for_label }}" class="form-label">
                                        {{ form.low.label }}
                                    </label>
                                    <input type="number" step="0.01" name="{{ form.low.name }}" id="{{ form.low.id_for_label }}" class="form-control{% if form.low.errors %} is-invalid{% endif %}" value="{{ form.low.value|default_if_none:'' }}">
                                    {% if form.low.errors %}
                                      <div class="invalid-feedback d-block">{{ form.low.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3" id="highField">
                                    <label for="{{ form.high.id_for_label }}" class="form-label">
                                        {{ form.high.label }}
                                    </label>
                                    <input type="number" step="0.01" name="{{ form.high.name }}" id="{{ form.high.id_for_label }}" class="form-control{% if form.high.errors %} is-invalid{% endif %}" value="{{ form.high.value|default_if_none:'' }}">
                                    {% if form.high.errors %}
                                      <div class="invalid-feedback d-block">{{ form.high.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Настройки каналов пределов -->
                            <div id="limitChannelsSection">
                                <div class="mb-3" id="chLowField">
                                    <label for="{{ form.ch_low.id_for_label }}" class="form-label" id="chLowLabel">
                                        {{ form.ch_low.label }}
                                    </label>
                                    <input type="text" name="{{ form.ch_low.name }}" id="{{ form.ch_low.id_for_label }}" class="form-control{% if form.ch_low.errors %} is-invalid{% endif %}" value="{{ form.ch_low.value|default_if_none:'' }}">
                                    {% if form.ch_low.errors %}
                                      <div class="invalid-feedback d-block">{{ form.ch_low.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3" id="chHighField">
                                    <label for="{{ form.ch_high.id_for_label }}" class="form-label" id="chHighLabel">
                                        {{ form.ch_high.label }}
                                    </label>
                                    <input type="text" name="{{ form.ch_high.name }}" id="{{ form.ch_high.id_for_label }}" class="form-control{% if form.ch_high.errors %} is-invalid{% endif %}" value="{{ form.ch_high.value|default_if_none:'' }}">
                                    {% if form.ch_high.errors %}
                                      <div class="invalid-feedback d-block">{{ form.ch_high.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Гистерезис -->
                    <div class="row" id="hysteresisSection">
                        <div class="col-12">
                            <h6 class="mb-3">Гистерезис</h6>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3" id="hystLowField">
                                        <label for="{{ form.hyst_low.id_for_label }}" class="form-label">
                                            {{ form.hyst_low.label }}
                                        </label>
                                        {{ form.hyst_low }}
                                        {% if form.hyst_low.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.hyst_low.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3" id="hystHighField">
                                        <label for="{{ form.hyst_high.id_for_label }}" class="form-label">
                                            {{ form.hyst_high.label }}
                                        </label>
                                        {{ form.hyst_high }}
                                        {% if form.hyst_high.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.hyst_high.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Общие настройки -->
                    <div class="row">
                        <div class="col-12">
                            
                            <div class="mb-3">
                                <label for="{{ form.msg.id_for_label }}" class="form-label required-field">
                                    {{ form.msg.label }}
                                </label>
                                <textarea name="{{ form.msg.name }}" id="{{ form.msg.id_for_label }}" class="form-control{% if form.msg.errors %} is-invalid{% endif %}" rows="3">{{ form.msg.value|default_if_none:'' }}</textarea>
                                {% if form.msg.errors %}
                                  <div class="invalid-feedback d-block">{{ form.msg.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.confirm_method.id_for_label }}" class="form-label required-field">
                                            {{ form.confirm_method.label }}
                                        </label>
                                        <select name="{{ form.confirm_method.name }}" id="{{ form.confirm_method.id_for_label }}" class="form-control{% if form.confirm_method.errors %} is-invalid{% endif %}">
                                            {% for val, label in form.confirm_method.field.choices %}
                                                <option value="{{ val }}"{% if form.confirm_method.value == val %} selected{% endif %}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                        {% if form.confirm_method.errors %}
                                          <div class="invalid-feedback d-block">{{ form.confirm_method.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.prior.id_for_label }}" class="form-label required-field">
                                            {{ form.prior.label }}
                                        </label>
                                        <input type="number" min="1" max="1000" name="{{ form.prior.name }}" id="{{ form.prior.id_for_label }}" class="form-control{% if form.prior.errors %} is-invalid{% endif %}" value="{{ form.prior.value|default_if_none:'' }}">
                                        {% if form.prior.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.prior.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'alarms:alarm_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Отмена
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> 
                            {% if form.instance.pk %}Сохранить{% else %}Создать{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Справка -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> Справка
                </h5>
            </div>
            <div class="card-body">
                <div id="helpContent">
                    <h6>Типы логики:</h6>
                    <ul class="list-unstyled">
                        <li><strong>discrete</strong> - дискретное событие (0/не 0)</li>
                        <li><strong>analog</strong> - аналоговое событие с пределами</li>
                        <li><strong>change</strong> - любое изменение события</li>
                        <li><strong>event</strong> - событие true/false</li>
                    </ul>
                    
                    <h6>Классы аварий:</h6>
                    <ul class="list-unstyled">
                        <li><strong>error</strong> - ошибка (высокий приоритет)</li>
                        <li><strong>warn</strong> - предупреждение</li>
                        <li><strong>info</strong> - информация</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    console.log('Form initialization started');
    console.log('jQuery version:', $.fn.jquery);
    
    // Проверяем наличие полей
    console.log('limitTypeField exists:', $('#limitTypeField').length > 0);
    console.log('limitConfigTypeField exists:', $('#limitConfigTypeField').length > 0);
    
    // Функция для показа/скрытия полей в зависимости от логики
    function toggleFieldsByLogic() {
        const logicSelect = $('#id_logic');
        const logic = logicSelect.val();
        console.log('Current logic value:', logic);
        console.log('Current logic text:', logicSelect.find('option:selected').text());
        
        // Скрываем все условные поля
        $('#limitTypeField, #limitConfigTypeField, #limitValuesSection, #limitChannelsSection, #hysteresisSection, #discreteValField').hide();
        
        // Убираем required-звёздочки
        $('#limitTypeField .form-label, #limitConfigTypeField .form-label').removeClass('required-field');
        
        // Проверяем по значению и по тексту для discrete
        if (logic === 'discrete' || logicSelect.find('option:selected').text().includes('Дискретное')) {
            console.log('Showing discrete fields');
            $('#discreteValField').show();
        }
        
        // Убираем required-звёздочки с полей гистерезиса для не-аналоговых логик
        if (logic !== 'analog' && !logicSelect.find('option:selected').text().includes('Аналоговое')) {
            $('#id_hyst_low').closest('.mb-3').find('.form-label').removeClass('required-field');
            $('#id_hyst_high').closest('.mb-3').find('.form-label').removeClass('required-field');
        }
        
        // Проверяем по значению и по тексту для analog
        if (logic === 'analog' || logicSelect.find('option:selected').text().includes('Аналоговое')) {
            console.log('Showing analog fields');
            $('#limitTypeField, #hysteresisSection').show();
            $('#limitTypeField .form-label').addClass('required-field');
            $('#id_hyst_low').closest('.mb-3').find('.form-label').addClass('required-field');
            $('#id_hyst_high').closest('.mb-3').find('.form-label').addClass('required-field');
            
            console.log('After show - limitTypeField visible:', $('#limitTypeField').is(':visible'));
            console.log('After show - limitConfigTypeField visible:', $('#limitConfigTypeField').is(':visible'));
            
            // Проверяем, есть ли уже выбранное значение в limit_type
            const limitType = $('#id_limit_type').val();
            if (limitType && limitType !== '') {
                console.log('Limit type already selected:', limitType);
                toggleLimitConfigType();
            }
        }
    }
    
    // Функция для показа/скрытия поля limit_config_type
    function toggleLimitConfigType() {
        const limitType = $('#id_limit_type').val();
        console.log('Toggle limit config type for limit type:', limitType);
        
        if (limitType && limitType !== '') {
            console.log('Showing limit config type field');
            $('#limitConfigTypeField').show();
            $('#limitConfigTypeField .form-label').addClass('required-field');
            
            // Проверяем, есть ли уже выбранное значение в limit_config_type
            const limitConfigType = $('#id_limit_config_type').val();
            if (limitConfigType && limitConfigType !== '') {
                console.log('Limit config type already selected:', limitConfigType);
                toggleLimitValues();
            } else {
                // Если limit_config_type не выбран, все равно управляем состоянием полей
                toggleFieldStates();
            }
        } else {
            console.log('Hiding limit config type field');
            $('#limitConfigTypeField').hide();
            $('#limitConfigTypeField .form-label').removeClass('required-field');
            // Скрываем также поля значений
            $('#limitValuesSection, #limitChannelsSection').hide();
            // Разблокируем все поля при сбросе limit_type
            toggleFieldStates();
        }
    }
    
    // Функция для показа/скрытия полей значений пределов
    function toggleLimitValues() {
        const limitType = $('#id_limit_type').val();
        const limitConfigType = $('#id_limit_config_type').val();
        console.log('Toggle limit values for limit type:', limitType, 'and config type:', limitConfigType);
        
        // Скрываем все секции значений
        $('#limitValuesSection, #limitChannelsSection').hide();
        
        // Проверяем условия для показа полей
        if (limitType && limitType !== '' && limitConfigType && limitConfigType !== '') {
            // Проверяем по значению и по тексту для values
            const limitConfigTypeText = $('#id_limit_config_type').find('option:selected').text();
            if (limitConfigType === 'values' || limitConfigTypeText.includes('Значения')) {
                console.log('Showing limit values fields');
                $('#limitValuesSection').show();
            } else if (limitConfigType === 'channels' || limitConfigTypeText.includes('Каналы')) {
                console.log('Showing limit channels fields');
                $('#limitChannelsSection').show();
            }
        }
        
        // Управляем состоянием полей
        toggleFieldStates();
    }
    
    // Функция для валидации обязательных полей при отправке формы
    function validateRequiredFields() {
        let isValid = true;
        let firstErrorField = null;
        
        console.log('=== validateRequiredFields called ===');
        
        // Список всех обязательных полей (базовые)
        const requiredFields = [
            { id: 'id_alarm_class', name: 'Класс тревоги' },
            { id: 'id_table', name: 'Таблица сообщений' },
            { id: 'id_logic', name: 'Способ наблюдения' },
            { id: 'id_channel', name: 'Имя канала' },
            { id: 'id_msg', name: 'Текст сообщения' },
            { id: 'id_confirm_method', name: 'Способ подтверждения' },
            { id: 'id_prior', name: 'Приоритет тревоги' }
        ];
        
        // Проверяем базовые обязательные поля
        requiredFields.forEach(field => {
            const element = $('#' + field.id);
            const value = element.val();
            
            if (!value || value === '' || value === '---------') {
                console.log('Required field empty:', field.name, 'value:', value);
                element.addClass('is-invalid');
                
                // Создаем или обновляем сообщение об ошибке
                let errorId = field.id + '-error';
                if (!$('#' + errorId).length) {
                    element.closest('.mb-3').append('<div id="' + errorId + '" class="invalid-feedback d-block">Обязательное поле</div>');
                }
                
                if (!firstErrorField) {
                    firstErrorField = element;
                }
                isValid = false;
            } else {
                element.removeClass('is-invalid');
                $('#' + field.id + '-error').remove();
            }
        });
        
        // Проверяем условные обязательные поля в зависимости от логики
        const logicText = $('#id_logic').find('option:selected').text();
        const logicValue = $('#id_logic').val();
        const limitTypeText = $('#id_limit_type').find('option:selected').text();
        const limitConfigTypeText = $('#id_limit_config_type').find('option:selected').text();
        
        console.log('=== VALIDATION DEBUG ===');
        console.log('Logic value:', logicValue);
        console.log('Logic text:', logicText);
        console.log('Is discrete logic:', logicValue === 'discrete' || logicText.includes('Дискретное'));
        console.log('Is analog logic:', logicValue === 'analog' || logicText.includes('Аналоговое'));
        
        // Для дискретной логики проверяем discrete_val
        const isDiscreteLogic = logicValue === 'discrete' || logicText.includes('Дискретное');
        const isAnalogLogic = logicValue === 'analog' || logicText.includes('Аналоговое');
        
        // Если логика не выбрана, не проверяем условные поля
        if (!logicValue || logicValue === '' || logicText === '---------') {
            console.log('Logic not selected - skipping conditional validation');
            // Убираем все ошибки с условных полей
            $('#id_discrete_val, #id_limit_type, #id_limit_config_type, #id_low, #id_high, #id_ch_low, #id_ch_high, #id_hyst_low, #id_hyst_high').removeClass('is-invalid');
            $('#id_discrete_val-error, #id_limit_type-error, #id_limit_config_type-error, #id_low-error, #id_high-error, #id_ch_low-error, #id_ch_high-error, #id_hyst_low-error, #id_hyst_high-error').remove();
        } else if (isDiscreteLogic) {
            console.log('Checking discrete_val for discrete logic');
            const discreteVal = $('#id_discrete_val').val();
            if (!discreteVal || discreteVal === '') {
                console.log('Discrete value required but empty');
                $('#id_discrete_val').addClass('is-invalid');
                if (!$('#id_discrete_val-error').length) {
                    $('#discreteValField').append('<div id="id_discrete_val-error" class="invalid-feedback d-block">Обязательное поле</div>');
                }
                if (!firstErrorField) {
                    firstErrorField = $('#id_discrete_val');
                }
                isValid = false;
            } else {
                $('#id_discrete_val').removeClass('is-invalid');
                $('#id_discrete_val-error').remove();
            }
            
            // Убираем ошибки с полей гистерезиса для дискретной логики
            $('#id_hyst_low, #id_hyst_high').removeClass('is-invalid');
            $('#id_hyst_low-error, #id_hyst_high-error').remove();
        } else if (isAnalogLogic) {
            console.log('Checking analog fields for analog logic');
            if (!limitTypeText || limitTypeText === '---------') {
                console.log('Limit type required but empty');
                $('#id_limit_type').addClass('is-invalid');
                if (!$('#id_limit_type-error').length) {
                    $('#limitTypeField').append('<div id="id_limit_type-error" class="invalid-feedback d-block">Обязательное поле</div>');
                }
                if (!firstErrorField) {
                    firstErrorField = $('#id_limit_type');
                }
                isValid = false;
            } else {
                $('#id_limit_type').removeClass('is-invalid');
                $('#id_limit_type-error').remove();
            }
            
            // Проверяем поля гистерезиса для аналоговой логики
            const hystLow = $('#id_hyst_low').val();
            const hystHigh = $('#id_hyst_high').val();
            
            if (!hystLow || hystLow === '') {
                console.log('Hyst low required but empty');
                $('#id_hyst_low').addClass('is-invalid');
                if (!$('#id_hyst_low-error').length) {
                    $('#id_hyst_low').closest('.mb-3').append('<div id="id_hyst_low-error" class="invalid-feedback d-block">Обязательное поле для аналоговых событий</div>');
                }
                if (!firstErrorField) {
                    firstErrorField = $('#id_hyst_low');
                }
                isValid = false;
            } else {
                $('#id_hyst_low').removeClass('is-invalid');
                $('#id_hyst_low-error').remove();
            }
            
            if (!hystHigh || hystHigh === '') {
                console.log('Hyst high required but empty');
                $('#id_hyst_high').addClass('is-invalid');
                if (!$('#id_hyst_high-error').length) {
                    $('#id_hyst_high').closest('.mb-3').append('<div id="id_hyst_high-error" class="invalid-feedback d-block">Обязательное поле для аналоговых событий</div>');
                }
                if (!firstErrorField) {
                    firstErrorField = $('#id_hyst_high');
                }
                isValid = false;
            } else {
                $('#id_hyst_high').removeClass('is-invalid');
                $('#id_hyst_high-error').remove();
            }
            
            if (limitTypeText && limitTypeText !== '---------') {
                if (!limitConfigTypeText || limitConfigTypeText === '---------') {
                    console.log('Limit config type required but empty');
                    $('#id_limit_config_type').addClass('is-invalid');
                    if (!$('#id_limit_config_type-error').length) {
                        $('#limitConfigTypeField').append('<div id="id_limit_config_type-error" class="invalid-feedback d-block">Обязательное поле</div>');
                    }
                    if (!firstErrorField) {
                        firstErrorField = $('#id_limit_config_type');
                    }
                    isValid = false;
                } else {
                    $('#id_limit_config_type').removeClass('is-invalid');
                    $('#id_limit_config_type-error').remove();
                }
            }
            
            // Проверяем поля значений в зависимости от типа конфигурации
            if (limitConfigTypeText && limitConfigTypeText.includes('Значения')) {
                // Проверяем поля low и high в зависимости от типа ограничения
                if (limitTypeText.includes('снизу') && (!$('#id_low').val() || $('#id_low').val() === '')) {
                    console.log('Low value required but empty');
                    $('#id_low').addClass('is-invalid');
                    if (!$('#id_low-error').length) {
                        $('#lowField').append('<div id="id_low-error" class="invalid-feedback d-block">Обязательное поле</div>');
                    }
                    if (!firstErrorField) {
                        firstErrorField = $('#id_low');
                    }
                    isValid = false;
                } else {
                    $('#id_low').removeClass('is-invalid');
                    $('#id_low-error').remove();
                }
                
                if (limitTypeText.includes('сверху') && (!$('#id_high').val() || $('#id_high').val() === '')) {
                    console.log('High value required but empty');
                    $('#id_high').addClass('is-invalid');
                    if (!$('#id_high-error').length) {
                        $('#highField').append('<div id="id_high-error" class="invalid-feedback d-block">Обязательное поле</div>');
                    }
                    if (!firstErrorField) {
                        firstErrorField = $('#id_high');
                    }
                    isValid = false;
                } else {
                    $('#id_high').removeClass('is-invalid');
                    $('#id_high-error').remove();
                }
            }
            
            if (limitConfigTypeText && limitConfigTypeText.includes('Каналы')) {
                // Проверяем поля ch_low и ch_high в зависимости от типа ограничения
                if (limitTypeText.includes('снизу') && (!$('#id_ch_low').val() || $('#id_ch_low').val() === '')) {
                    console.log('Ch_low value required but empty');
                    $('#id_ch_low').addClass('is-invalid');
                    if (!$('#id_ch_low-error').length) {
                        $('#chLowField').append('<div id="id_ch_low-error" class="invalid-feedback d-block">Обязательное поле</div>');
                    }
                    if (!firstErrorField) {
                        firstErrorField = $('#id_ch_low');
                    }
                    isValid = false;
                } else {
                    $('#id_ch_low').removeClass('is-invalid');
                    $('#id_ch_low-error').remove();
                }
                
                if (limitTypeText.includes('сверху') && (!$('#id_ch_high').val() || $('#id_ch_high').val() === '')) {
                    console.log('Ch_high value required but empty');
                    $('#id_ch_high').addClass('is-invalid');
                    if (!$('#id_ch_high-error').length) {
                        $('#chHighField').append('<div id="id_ch_high-error" class="invalid-feedback d-block">Обязательное поле</div>');
                    }
                    if (!firstErrorField) {
                        firstErrorField = $('#id_ch_high');
                    }
                    isValid = false;
                } else {
                    $('#id_ch_high').removeClass('is-invalid');
                    $('#id_ch_high-error').remove();
                }
            }
        } else {
            console.log('Unknown logic type - removing all conditional field errors');
            // Для неизвестной логики убираем ошибки с условных полей
            $('#id_discrete_val, #id_limit_type, #id_limit_config_type, #id_low, #id_high, #id_ch_low, #id_ch_high').removeClass('is-invalid');
            $('#id_discrete_val-error, #id_limit_type-error, #id_limit_config_type-error, #id_low-error, #id_high-error, #id_ch_low-error, #id_ch_high-error').remove();
        }
        
        // Прокручиваем к первому полю с ошибкой
        if (firstErrorField) {
            firstErrorField[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        console.log('Form validation result:', isValid);
        return isValid;
    }
    
    // Функция для валидации значений low и high
    function validateLowHighValues() {
        const limitType = $('#id_limit_type').val();
        const limitConfigType = $('#id_limit_config_type').val();
        const limitTypeText = $('#id_limit_type').find('option:selected').text();
        const limitConfigTypeText = $('#id_limit_config_type').find('option:selected').text();
        
        console.log('=== validateLowHighValues called ===');
        console.log('limit_type:', limitType, 'text:', limitTypeText);
        console.log('limit_config_type:', limitConfigType, 'text:', limitConfigTypeText);
        
        // Проверяем условия для валидации
        const isLowHigh = limitTypeText.includes('снизу') && limitTypeText.includes('сверху');
        const isValues = limitConfigTypeText.includes('Значения') || limitConfigType === 'values';
        
        console.log('isLowHigh:', isLowHigh, 'isValues:', isValues);
        
        if (isLowHigh && isValues) {
            const lowValue = parseFloat($('#id_low').val()) || 0;
            const highValue = parseFloat($('#id_high').val()) || 0;
            
            console.log('lowValue:', lowValue, 'highValue:', highValue);
            
            if (lowValue >= highValue) {
                console.log('*** VALIDATION ERROR: low >= high ***');
                // Показываем ошибку
                $('#id_low, #id_high').addClass('is-invalid');
                
                // Создаем или обновляем сообщение об ошибке
                let errorMsg = 'Значение нижнего предела должно быть меньше верхнего предела';
                
                if (!$('#low-high-error').length) {
                    $('#lowField').append('<div id="low-high-error" class="invalid-feedback d-block">' + errorMsg + '</div>');
                } else {
                    $('#low-high-error').text(errorMsg);
                }
                
                return false;
            } else {
                console.log('*** VALIDATION OK: low < high ***');
                // Убираем ошибку
                $('#id_low, #id_high').removeClass('is-invalid');
                $('#low-high-error').remove();
                return true;
            }
        } else {
            // Убираем ошибку если условия не выполняются
            $('#id_low, #id_high').removeClass('is-invalid');
            $('#low-high-error').remove();
            return true;
        }
    }
    
    // Функция для управления состоянием полей в зависимости от типа ограничения
    function toggleFieldStates() {
        const limitType = $('#id_limit_type').val();
        const limitTypeText = $('#id_limit_type').find('option:selected').text();
        console.log('=== toggleFieldStates called ===');
        console.log('limit_type value:', limitType);
        console.log('limit_type text:', limitTypeText);
        
        // Проверяем существование полей
        console.log('Fields exist check:');
        console.log('id_low exists:', $('#id_low').length > 0);
        console.log('id_high exists:', $('#id_high').length > 0);
        console.log('id_ch_low exists:', $('#id_ch_low').length > 0);
        console.log('id_ch_high exists:', $('#id_ch_high').length > 0);
        
        // Сначала разблокируем все поля и убираем обязательность
        $('#id_low, #id_high, #id_ch_low, #id_ch_high').prop('disabled', false);
        $('#lowField .form-label, #highField .form-label, #chLowField .form-label, #chHighField .form-label').removeClass('disabled required-field');
        
        console.log('After enabling all fields:');
        console.log('low disabled:', $('#id_low').prop('disabled'));
        console.log('high disabled:', $('#id_high').prop('disabled'));
        console.log('ch_low disabled:', $('#id_ch_low').prop('disabled'));
        console.log('ch_high disabled:', $('#id_ch_high').prop('disabled'));
        
        // Простая логика: если текст содержит только "снизу" - блокируем high
        if (limitTypeText.includes('снизу') && !limitTypeText.includes('сверху')) {
            console.log('*** LOW ONLY: Disabling high fields ***');
            $('#id_high, #id_ch_high').prop('disabled', true);
            $('#highField .form-label, #chHighField .form-label').addClass('disabled');
            // Делаем low поля обязательными
            $('#lowField .form-label, #chLowField .form-label').addClass('required-field');
            // Устанавливаем дефолтные значения для low полей если они пустые
            if (!$('#id_low').val()) {
                $('#id_low').val('0.0'); // Дефолтное значение из модели AlarmConfig
            }
            if (!$('#id_ch_low').val()) {
                $('#id_ch_low').val(''); // Дефолтное значение для канала - пустая строка
            }
        }
        
        // Если текст содержит только "сверху" - блокируем low
        if (limitTypeText.includes('сверху') && !limitTypeText.includes('снизу')) {
            console.log('*** HIGH ONLY: Disabling low fields ***');
            $('#id_low, #id_ch_low').prop('disabled', true);
            $('#lowField .form-label, #chLowField .form-label').addClass('disabled');
            // Делаем high поля обязательными
            $('#highField .form-label, #chHighField .form-label').addClass('required-field');
            // Устанавливаем дефолтные значения для high полей если они пустые
            if (!$('#id_high').val()) {
                $('#id_high').val('0.0'); // Дефолтное значение из модели AlarmConfig
            }
            if (!$('#id_ch_high').val()) {
                $('#id_ch_high').val(''); // Дефолтное значение для канала - пустая строка
            }
        }
        
        // Если содержит и "снизу" и "сверху" - ничего не блокируем, но делаем все обязательными
        if (limitTypeText.includes('снизу') && limitTypeText.includes('сверху')) {
            console.log('*** BOTH: All fields enabled and required ***');
            $('#lowField .form-label, #highField .form-label, #chLowField .form-label, #chHighField .form-label').addClass('required-field');
            // Устанавливаем дефолтные значения для всех полей если они пустые
            if (!$('#id_low').val()) {
                $('#id_low').val('0.0'); // Дефолтное значение из модели AlarmConfig
            }
            if (!$('#id_high').val()) {
                $('#id_high').val('0.0'); // Дефолтное значение из модели AlarmConfig
            }
            if (!$('#id_ch_low').val()) {
                $('#id_ch_low').val(''); // Дефолтное значение для канала - пустая строка
            }
            if (!$('#id_ch_high').val()) {
                $('#id_ch_high').val(''); // Дефолтное значение для канала - пустая строка
            }
        }
        
        // Выполняем валидацию после установки значений
        validateLowHighValues();
        
        console.log('Final state:');
        console.log('low disabled:', $('#id_low').prop('disabled'));
        console.log('high disabled:', $('#id_high').prop('disabled'));
        console.log('ch_low disabled:', $('#id_ch_low').prop('disabled'));
        console.log('ch_high disabled:', $('#id_ch_high').prop('disabled'));
        console.log('=== toggleFieldStates finished ===');
    }
    
    // Обработчик изменения логики
    $('#id_logic').on('change', function() {
        console.log('Logic changed to:', $(this).val());
        console.log('Logic text:', $(this).find('option:selected').text());
        toggleFieldsByLogic();
    });
    
    // Обработчик изменения типа ограничения
    $('#id_limit_type').on('change', function() {
        console.log('Limit type changed to:', $(this).val());
        toggleLimitConfigType();
    });
    
    // Обработчик изменения типа конфигурации ограничения
    $('#id_limit_config_type').on('change', function() {
        console.log('Limit config type changed to:', $(this).val());
        toggleLimitValues();
    });
    
    // Обработчики изменения значений полей low и high для валидации
    $('#id_low, #id_high').on('input', function() {
        console.log('Field value changed:', $(this).attr('id'), 'value:', $(this).val());
        validateLowHighValues();
    });
    
    // Инициализация при загрузке страницы
    toggleFieldsByLogic();
    
    // Обработчик отправки формы
    $('#alarmForm').on('submit', function(e) {
        console.log('Form submit event triggered');
        
        // Предотвращаем браузерную валидацию
        e.stopImmediatePropagation();
        
        // Убираем все красные рамки и сообщения об ошибках перед валидацией
        $('.is-invalid').removeClass('is-invalid');
        $('.invalid-feedback').remove();
        
        // Выполняем валидацию обязательных полей
        if (!validateRequiredFields()) {
            console.log('Form validation failed - preventing submit');
            e.preventDefault();
            return false;
        }
        
        // Дополнительная валидация для low < high
        if (!validateLowHighValues()) {
            console.log('Low/High validation failed - preventing submit');
            e.preventDefault();
            return false;
        }
        
        console.log('Form validation passed - allowing submit');
        return true;
    });
    
    // Глобальная блокировка браузерной валидации
    $(document).on('invalid', 'input, select, textarea', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        return false;
    });
    
    // Дополнительная блокировка для всех элементов формы
    $('#alarmForm').on('invalid', 'input, select, textarea', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        return false;
    });
    
    // Дополнительная проверка через 1 секунду
    setTimeout(function() {
        console.log('Delayed initialization');
        toggleFieldsByLogic();
    }, 1000);
    
    // Еще одна проверка через 2 секунды
    setTimeout(function() {
        console.log('Second delayed initialization');
        toggleFieldsByLogic();
    }, 2000);
});
</script>
{% endblock %} 
{% extends 'base.html' %}
{% load static %}

{% block title %}{% include 'alarms/includes/page_title.html' with page_title="Тревоги" %}{% endblock %}

{% block extra_css %}
<style>
    /* CSS ПЕРЕМЕННЫЕ ДЛЯ АДАПТИВНОЙ ВЫСОТЫ */
    :root {
        --controls-panel-height: 120px; /* Примерная высота панели управления */
        --page-padding: 1rem; /* Минимальные отступы страницы */
        --header-height: 0px; /* Высота заголовка страницы (если есть) */
    }
    
    /* АДАПТИВНАЯ ШИРИНА КОНТЕЙНЕРОВ */
    
    /* Панель управления - зафиксирована сверху */
    .controls-panel {
        margin-left: 0;
        margin-right: 0;
        position: sticky;
        top: 0;
        z-index: 100;
        background-color: var(--bs-body-bg);
        border-bottom: 1px solid var(--bs-border-color);
        padding-bottom: 0.5rem;
        /* Убираем ограничения ширины для горизонтального скролла */
        width: 100%;
        overflow-x: auto; /* Горизонтальный скролл для панели управления */
    }
    
    /* Таблица тревог - адаптивная высота, занимает всё доступное пространство */
    .card {
        margin-left: 0;
        margin-right: 0;
        margin-bottom: 0; /* Убираем нижний отступ */
        display: flex;
        flex-direction: column;
        /* Максимальная высота: занимаем всё пространство до конца экрана */
        height: calc(100vh - var(--controls-panel-height) - var(--page-padding));
        min-height: calc(100vh - var(--controls-panel-height) - var(--page-padding));
        /* Убираем ограничения ширины для горизонтального скролла */
        width: 100%;
        overflow: hidden; /* Скрываем переполнение карточки */
    }
    
    /* Заголовок таблицы - полностью зафиксирован и непрокручиваемый */
    .alarm-table thead {
        position: sticky;
        top: 0;
        z-index: 15;
        background-color: var(--bs-body-bg);
    }
    
    .alarm-table thead th {
        position: sticky;
        top: 0;
        background-color: var(--bs-light);
        z-index: 20;
        border-bottom: 2px solid var(--bs-border-color);
        /* Дополнительные стили для надежной фиксации */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        /* Убираем возможность прокрутки заголовков */
        will-change: transform;
        transform: translateZ(0);
        white-space: nowrap;
        /* Минимальная высота для стабильности */
        min-height: 40px;
        height: auto;
        line-height: 1.2;
        vertical-align: middle;
        /* Принудительная фиксация */
        position: -webkit-sticky; /* Safari support */
        position: sticky;
        /* Убираем любые margin/padding которые могут мешать */
        margin: 0;
        /* Гарантируем непрозрачность фона */
        background-clip: padding-box;
    }
    
    /* Тело таблицы - прокручиваемое */
    .alarm-table tbody {
        position: relative;
        z-index: 1;
    }
    
    .alarm-table tbody tr {
        /* Оптимизация отрисовки строк */
        will-change: auto;
        transform: translateZ(0);
    }
    
    /* Темная тема для заголовка */
    [data-bs-theme="dark"] .alarm-table thead {
        background-color: var(--bs-body-bg);
    }
    
    [data-bs-theme="dark"] .alarm-table thead th {
        background-color: var(--bs-dark);
        box-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
    }
    
    /* Контейнер таблицы - занимает всё доступное пространство с фиксированной шапкой */
    .table-responsive {
        flex-grow: 1;
        overflow-y: auto; /* Вертикальная прокрутка */
        overflow-x: auto; /* Горизонтальная прокрутка */
        /* Занимаем всё оставшееся пространство в карточке */
        height: 100%;
        min-height: 300px; /* Минимальная высота для удобства использования */
        max-height: calc(100vh - var(--controls-panel-height) - var(--page-padding) - 40px); /* Ограничиваем максимальную высоту */
        /* Улучшенная фиксация для sticky элементов */
        position: relative;
        contain: layout style paint;
        /* Оптимизация прокрутки */
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        /* Принудительное отображение скроллбаров */
        scrollbar-width: auto; /* Firefox */
        -ms-overflow-style: auto; /* IE */
    }
    
    /* Обеспечиваем видимость скроллбаров в Webkit браузерах */
    .table-responsive::-webkit-scrollbar {
        width: 12px;
        height: 12px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
        background: var(--bs-secondary-bg);
        border-radius: 6px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
        background: var(--bs-secondary);
        border-radius: 6px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: var(--bs-secondary-color);
    }
    
    /* Адаптация для минимизированного сайдбара - убрана для горизонтального скролла */
    
    /* Адаптивность для разных размеров экрана */
    
    /* Планшеты и маленькие экраны */
    @media (max-width: 1200px) {
        :root {
            --controls-panel-height: 140px; /* Увеличенная высота на средних экранах */
        }
    }
    
    /* Мобильные устройства */
    @media (max-width: 768px) {
        :root {
            --controls-panel-height: 180px; /* Еще больше высота на мобильных */
            --page-padding: 0.5rem; /* Минимальные отступы на мобильных */
        }
        
        .table-responsive {
            min-height: 250px; /* Уменьшенная минимальная высота на мобильных */
        }
        
        .container-fluid {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            padding-top: 0.5rem;
        }
    }
    
    /* Очень маленькие экраны */
    @media (max-width: 480px) {
        :root {
            --controls-panel-height: 220px; /* Максимальная высота на очень маленьких экранах */
            --page-padding: 0.25rem; /* Минимальные отступы */
        }
        
        .table-responsive {
            min-height: 200px; /* Еще меньше на очень маленьких экранах */
        }
        
        .container-fluid {
            padding: 0.25rem;
        }
    }
    
    /* Большие экраны */
    @media (min-width: 1400px) {
        :root {
            --controls-panel-height: 100px; /* Компактная высота на больших экранах */
        }
        
        .table-responsive {
            min-height: 500px; /* Увеличенная минимальная высота на больших экранах */
        }
    }
    
    /* СТИЛИ СТРАНИЦЫ И ТАБЛИЦЫ */
    
    /* Убираем прокрутку всей страницы - только внутренняя прокрутка таблицы */
    html, body {
        overflow: hidden; /* Полностью убираем прокрутку страницы */
        height: 100vh; /* Фиксированная высота */
        margin: 0;
        padding: 0;
    }
    
    /* Центрирование всех ячеек таблицы тревог */
    .alarm-table td,
    .alarm-table th {
        text-align: center;
        vertical-align: middle;
    }
    
    /* Исключение для столбца действий - оставляем выравнивание по левому краю */
    .alarm-table td:first-child {
        text-align: left;
    }
    

    
    /* Настройки для горизонтального скролла таблицы */
    .alarm-table {
        min-width: 1800px; /* Минимальная ширина таблицы для принудительного горизонтального скролла */
        width: max-content; /* Автоматическая ширина на основе содержимого */
    }
    
    .alarm-table th,
    .alarm-table td {
        white-space: nowrap; /* Предотвращение переноса текста */
        overflow: hidden;
        text-overflow: ellipsis; /* Троеточие для длинного текста */
        padding: 8px 12px; /* Увеличенные отступы для лучшего вида */
        width: auto; /* Автоматическая ширина под содержимое */
    }
    
    /* Специальные настройки для отдельных столбцов */
    .alarm-table th:nth-child(1), /* Действия */
    .alarm-table td:nth-child(1) {
        white-space: normal; /* Разрешаем перенос для кнопок */
        width: auto; /* Автоматическая ширина под содержимое */
    }
    
    .alarm-table th:nth-child(2), /* ID */
    .alarm-table td:nth-child(2) {
        width: auto; /* Автоматическая ширина под содержимое */
    }
    
    .alarm-table th:nth-child(3), /* Канал */
    .alarm-table td:nth-child(3) {
        width: auto; /* Автоматическая ширина под содержимое */
    }
    
    .alarm-table th:nth-child(4), /* Сообщение */
    .alarm-table td:nth-child(4) {
        max-width: 250px; /* Ограничение максимальной ширины */
        width: auto; /* Автоматическая ширина под содержимое */
    }
    
    .alarm-table th:nth-child(5), /* Таблица */
    .alarm-table td:nth-child(5) {
        max-width: 250px; /* Ограничение максимальной ширины */
        width: auto; /* Автоматическая ширина под содержимое */
    }
    
    /* Контейнер карточки таблицы */
    .card-body {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        padding-bottom: 0;
        overflow: hidden;
        /* Плавная адаптация при изменении высоты */
        transition: all 0.3s ease;
    }
    
    /* Стили для пустого состояния */
    .empty-state {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-grow: 1;
        min-height: 300px;
    }
    
    /* Контейнер основного контента - точная высота без прокрутки */
    .container-fluid {
        padding-left: 1rem;
        padding-right: 1rem;
        padding-top: 1rem;
        padding-bottom: 0; /* Убираем нижний отступ */
        max-width: none;
        width: 100%;
        height: 100%; /* Занимаем всю доступную высоту */
        max-height: 100%; /* Не превышаем доступную высоту */
        display: flex;
        flex-direction: column;
        overflow: hidden; /* Убираем прокрутку контейнера, но разрешаем для таблицы */
    }
    
    /* Основной контент - адаптивная высота с учетом сайдбара */
    .main-content {
        padding-top: 0;
        padding-bottom: 0; /* Убираем нижний отступ */
        /* Адаптивная высота с учетом того, что сайдбар занимает место слева */
        height: 100vh; 
        max-height: 100vh; 
        display: flex;
        flex-direction: column;
        overflow: hidden; /* Убираем прокрутку основного контента */
        /* Отступ слева под сайдбар */
        margin-left: 250px; /* Ширина развернутого сайдбара */
        transition: margin-left 0.3s ease;
    }
    
    /* Адаптация основного контента для минимизированного сайдбара */
    body.sidebar-minimized .main-content {
        margin-left: 70px; /* Ширина минимизированного сайдбара */
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Функция для динамической адаптации высоты таблицы с учетом зафиксированного заголовка
function adaptTableHeight() {
    // Получаем реальные высоты элементов
    const controlsPanel = document.querySelector('.controls-panel');
    const tableHeader = document.querySelector('.alarm-table thead');
    const containerFluid = document.querySelector('.container-fluid');
    const tableContainer = document.querySelector('.table-responsive');
    const card = document.querySelector('.card');
    
    if (controlsPanel && card && tableContainer) {
        // Измеряем фактические высоты
        const controlsPanelHeight = controlsPanel.offsetHeight;
        let tableHeaderHeight = 0;
        
        if (tableHeader) {
            tableHeaderHeight = tableHeader.offsetHeight;
        }
        
        // Получаем реальные отступы контейнера
        let containerPadding = 16; // по умолчанию 1rem
        if (containerFluid) {
            const computedStyle = window.getComputedStyle(containerFluid);
            containerPadding = parseFloat(computedStyle.paddingTop) + parseFloat(computedStyle.paddingBottom);
        }
        
        // Рассчитываем доступную высоту для таблицы
        const viewportHeight = window.innerHeight;
        const availableHeight = viewportHeight - controlsPanelHeight - containerPadding - 40; // 40px запас
        
        // Устанавливаем максимальную высоту для контейнера таблицы
        tableContainer.style.maxHeight = `${availableHeight}px`;
        tableContainer.style.height = `${availableHeight}px`;
        
        // Обновляем CSS переменные с реальными значениями
        document.documentElement.style.setProperty('--controls-panel-height', `${controlsPanelHeight}px`);
        document.documentElement.style.setProperty('--page-padding', `${containerPadding}px`);
        
        // Принудительно обновляем sticky позиционирование заголовка
        if (tableHeader) {
            tableHeader.style.position = 'sticky';
            tableHeader.style.top = '0';
            tableHeader.style.zIndex = '15';
            
            // Обновляем стили для каждого th в заголовке
            const headerCells = tableHeader.querySelectorAll('th');
            headerCells.forEach(th => {
                th.style.position = 'sticky';
                th.style.top = '0';
                th.style.zIndex = '20';
            });
        }
        
        console.log(`Адаптивная высота: viewport ${viewportHeight}px, панель ${controlsPanelHeight}px, доступно для таблицы ${availableHeight}px`);
    }
}

// Функция для принудительной фиксации заголовка таблицы
function enforceTableHeaderSticky() {
    const tableHeader = document.querySelector('.alarm-table thead');
    const tableContainer = document.querySelector('.table-responsive');
    
    if (tableHeader && tableContainer) {
        // Проверяем, действительно ли заголовок зафиксирован
        const headerRect = tableHeader.getBoundingClientRect();
        const containerRect = tableContainer.getBoundingClientRect();
        
        // Если заголовок находится вне видимой области контейнера
        if (headerRect.top < containerRect.top || headerRect.top > containerRect.bottom) {
            // Принудительно применяем sticky стили
            tableHeader.style.position = 'sticky';
            tableHeader.style.top = '0px';
            tableHeader.style.zIndex = '15';
            
            const headerCells = tableHeader.querySelectorAll('th');
            headerCells.forEach(th => {
                th.style.position = 'sticky';
                th.style.top = '0px';
                th.style.zIndex = '20';
                th.style.backgroundColor = getComputedStyle(th).backgroundColor;
            });
            
            console.log('Принудительно применена фиксация заголовка таблицы');
        }
    }
}

// Адаптация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Небольшая задержка для полной загрузки CSS
    setTimeout(adaptTableHeight, 100);
    setTimeout(enforceTableHeaderSticky, 200);
    
    // Повторная адаптация через секунду для учета динамических изменений
    setTimeout(adaptTableHeight, 1000);
    setTimeout(enforceTableHeaderSticky, 1100);
});

// Адаптация при изменении размера окна
window.addEventListener('resize', function() {
    // Дебаунсинг для производительности
    clearTimeout(window.resizeTimeout);
    window.resizeTimeout = setTimeout(function() {
        adaptTableHeight();
        enforceTableHeaderSticky();
    }, 150);
});

// Адаптация при переключении сайдбара
document.addEventListener('click', function(event) {
    // Если кликнули по кнопке переключения сайдбара
    if (event.target.closest('button[onclick*="toggleSidebar"]')) {
        // Задержка для завершения анимации сайдбара
        setTimeout(function() {
            adaptTableHeight();
            enforceTableHeaderSticky();
        }, 350);
    }
});

// Проверка фиксации заголовка при прокрутке таблицы
const tableContainer = document.querySelector('.table-responsive');
if (tableContainer) {
    tableContainer.addEventListener('scroll', function() {
        // Периодическая проверка фиксации при прокрутке
        clearTimeout(window.scrollTimeout);
        window.scrollTimeout = setTimeout(enforceTableHeaderSticky, 50);
    });
}

// Наблюдатель за изменениями в панели управления
if (window.ResizeObserver) {
    const resizeObserver = new ResizeObserver(function(entries) {
        adaptTableHeight();
        setTimeout(enforceTableHeaderSticky, 100);
    });
    
    // Наблюдаем за панелью управления
    const controlsPanel = document.querySelector('.controls-panel');
    if (controlsPanel) {
        resizeObserver.observe(controlsPanel);
    }
    
    // Наблюдаем за заголовком таблицы
    const tableHeader = document.querySelector('.alarm-table thead');
    if (tableHeader) {
        resizeObserver.observe(tableHeader);
    }
}

// Наблюдатель за изменениями в DOM (например, при сворачивании/разворачивании табов)
if (window.MutationObserver) {
    const mutationObserver = new MutationObserver(function(mutations) {
        let shouldUpdate = false;
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && 
                (mutation.attributeName === 'style' || mutation.attributeName === 'class')) {
                shouldUpdate = true;
            }
        });
        
        if (shouldUpdate) {
            setTimeout(function() {
                adaptTableHeight();
                enforceTableHeaderSticky();
            }, 100);
        }
    });
    
    // Наблюдаем за изменениями в панели управления
    const controlsPanel = document.querySelector('.controls-panel');
    if (controlsPanel) {
        mutationObserver.observe(controlsPanel, {
            attributes: true,
            subtree: true,
            attributeFilter: ['style', 'class']
        });
    }
    
    // Наблюдаем за изменениями в таблице
    const alarmTable = document.querySelector('.alarm-table');
    if (alarmTable) {
        mutationObserver.observe(alarmTable, {
            attributes: true,
            subtree: true,
            attributeFilter: ['style', 'class']
        });
    }
}
</script>
{% endblock %}

{% block content %}
<!-- ПАНЕЛЬ УПРАВЛЕНИЯ (ФИЛЬТРЫ + СОРТИРОВКА) -->
{% include 'alarms/includes/controls_panel.html' with page_type='alarms' %}

<div class="card">
    <div class="card-body">
        {% if alarms %}
            <div class="table-responsive" id="alarmTableContainer">
                    <table class="table table-hover alarm-table">
                        <thead class="table-light">
                            <tr>
                                <th>Действия</th>
                                <th>
                                    ID
                                    {% if 'id' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.id == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th>
                                    Канал
                                    {% if 'channel' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.channel == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th>
                                    Сообщение
                                    {% if 'msg' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.msg == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th>
                                    Таблица
                                    {% if 'table' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.table == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th title="Класс тревоги">
                                    Класс
                                    {% if 'alarm_class' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.alarm_class == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th title="Способ наблюдения">
                                    Логика
                                    {% if 'logic' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.logic == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th title="Способ подтверждения">
                                    Подтверждение
                                    {% if 'confirm_method' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.confirm_method == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th>
                                    Приоритет
                                    {% if 'prior' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.prior == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th title="Тип ограничения">
                                    Лимит
                                    {% if 'limit_type' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.limit_type == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th title="Тип настройки пределов">
                                    Тип лимита
                                    {% if 'limit_config_type' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.limit_config_type == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th title="Нижний предел">
                                    Мин
                                    {% if 'low' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.low == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th title="Верхний предел">
                                    Макс
                                    {% if 'high' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.high == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th title="Канал нижнего предела">
                                    Канал мин
                                    {% if 'ch_low' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.ch_low == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th title="Канал верхнего предела">
                                    Канал макс
                                    {% if 'ch_high' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.ch_high == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th title="Гистерезис нижнего предела">
                                    Гист мин
                                    {% if 'hyst_low' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.hyst_low == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th title="Гистерезис верхнего предела">
                                    Гист макс
                                    {% if 'hyst_high' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.hyst_high == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th title="Значение предела для дискретного сигнала">
                                    Дискрет
                                    {% if 'discrete_val' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.discrete_val == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th title="Дата создания">
                                    Создано
                                    {% if 'created_at' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.created_at == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th title="Дата обновления">
                                    Обновлено
                                    {% if 'updated_at' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.updated_at == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alarm in alarms %}
                            <tr>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'alarms:alarm_edit' alarm.pk %}" 
                                           class="btn btn-sm btn-outline-primary" 
                                           title="Редактировать">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{% url 'alarms:alarm_delete' alarm.pk %}" 
                                           class="btn btn-sm btn-outline-danger" 
                                           title="Удалить"
                                           onclick="return confirm('Вы уверены, что хотите удалить эту тревогу?')">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                                <td>{{ alarm.id }}</td>
                                <td>
                                    {% if alarm.channel %}
                                        <code>{{ alarm.channel }}</code>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ alarm.msg }}</td>
                                <td title="{{ alarm.table.description|default:'Описание отсутствует' }}">
                                    {{ alarm.table.name }}
                                </td>
                                <td>
                                    <span class="badge bg-{% if alarm.alarm_class.name == 'error' %}alarm-error{% elif alarm.alarm_class.name == 'warn' %}alarm-warn{% elif alarm.alarm_class.name == 'info' %}alarm-info{% else %}secondary{% endif %}">
                                        {{ alarm.alarm_class.verbose_name_ru|default:"Не указан" }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-{% if alarm.logic.name == 'discrete' %}logic-discrete{% elif alarm.logic.name == 'analog' %}logic-analog{% elif alarm.logic.name == 'change' %}logic-change{% else %}secondary{% endif %}">{{ alarm.logic.verbose_name_ru|default:"Не указан" }}</span>
                                </td>
                                <td>
                                    {% if alarm.confirm_method %}
                                        <span class="badge bg-{% if alarm.confirm_method.name == 'rep_ack' %}confirm-rep-ack{% else %}secondary{% endif %}">{{ alarm.confirm_method.verbose_name_ru|default:"Не указан" }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ alarm.prior }}</span>
                                </td>
                                <td>
                                    {% if alarm.limit_type %}
                                        <span class="badge bg-{% if alarm.limit_type.name == 'low' %}limit-low{% elif alarm.limit_type.name == 'high' %}limit-high{% elif alarm.limit_type.name == 'low_high' %}limit-low-high{% else %}secondary{% endif %}">{{ alarm.limit_type.verbose_name_ru|default:"Не указан" }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if alarm.limit_config_type %}
                                        <span class="badge bg-{% if alarm.limit_config_type.name == 'values' %}config-values{% elif alarm.limit_config_type.name == 'channels' %}config-channels{% else %}secondary{% endif %}">{{ alarm.limit_config_type.verbose_name_ru|default:"Не указан" }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if alarm.low is not None %}
                                        {{ alarm.low }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if alarm.high is not None %}
                                        {{ alarm.high }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if alarm.ch_low %}
                                        <code>{{ alarm.ch_low }}</code>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if alarm.ch_high %}
                                        <code>{{ alarm.ch_high }}</code>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if alarm.hyst_low is not None %}
                                        {{ alarm.hyst_low }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if alarm.hyst_high is not None %}
                                        {{ alarm.hyst_high }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if alarm.discrete_val is not None %}
                                        {{ alarm.discrete_val }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ alarm.created_at|date:"d.m.Y H:i" }}</td>
                                <td>{{ alarm.updated_at|date:"d.m.Y H:i" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            
            <!-- Пагинация -->
            {% if is_paginated %}
            <nav aria-label="Навигация по страницам">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% for field in sort_fields %}&sort_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for order in sort_orders %}&order_{{ forloop.counter0 }}={{ order }}{% endfor %}{% for field in filter_fields %}&filter_field_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for op in filter_ops %}&filter_op_{{ forloop.counter0 }}={{ op }}{% endfor %}{% for value in filter_values %}&filter_value_{{ forloop.counter0 }}={{ value }}{% endfor %}">
                                <i class="bi bi-chevron-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for field in sort_fields %}&sort_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for order in sort_orders %}&order_{{ forloop.counter0 }}={{ order }}{% endfor %}{% for field in filter_fields %}&filter_field_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for op in filter_ops %}&filter_op_{{ forloop.counter0 }}={{ op }}{% endfor %}{% for value in filter_values %}&filter_value_{{ forloop.counter0 }}={{ value }}{% endfor %}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">
                            Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for field in sort_fields %}&sort_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for order in sort_orders %}&order_{{ forloop.counter0 }}={{ order }}{% endfor %}{% for field in filter_fields %}&filter_field_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for op in filter_ops %}&filter_op_{{ forloop.counter0 }}={{ op }}{% endfor %}{% for value in filter_values %}&filter_value_{{ forloop.counter0 }}={{ value }}{% endfor %}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for field in sort_fields %}&sort_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for order in sort_orders %}&order_{{ forloop.counter0 }}={{ order }}{% endfor %}{% for field in filter_fields %}&filter_field_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for op in filter_ops %}&filter_op_{{ forloop.counter0 }}={{ op }}{% endfor %}{% for value in filter_values %}&filter_value_{{ forloop.counter0 }}={{ value }}{% endfor %}">
                                <i class="bi bi-chevron-double-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        {% else %}
            <div class="empty-state text-center">
                <div>
                    {% if has_active_filters %}
                        {% include 'alarms/includes/empty_filtered.html' %}
                    {% else %}
                        <i class="bi bi-exclamation-triangle fs-1 text-muted"></i>
                        <h4 class="mt-3">Тревоги не найдены</h4>
                        <p class="text-muted">Создайте первую тревогу для начала работы</p>
                        <a href="{% url 'alarms:alarm_create' %}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Создать первую тревогу
                        </a>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script src="{% static 'js/filters.js' %}"></script>
<script src="{% static 'js/sort.js' %}"></script>
<script src="{% static 'js/dynamic_filters.js' %}"></script>

<script>

</script>
{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block title %}{% include 'alarms/includes/page_title.html' with page_title="–¢—Ä–µ–≤–æ–≥–∏" %}{% endblock %}

{% block extra_css %}
<!-- AG Grid CSS -->
<link rel="stylesheet" href="{% static 'libs/ag-grid/css/ag-grid.css' %}">
<link rel="stylesheet" href="{% static 'libs/ag-grid/css/ag-theme-alpine.css' %}">

<style>
    /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –ª—É—á—à–µ–π –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
    .container-fluid {
        max-width: none !important;
        padding-left: 15px !important;
        padding-right: 15px !important;
        height: 100vh; /* –ü–æ–ª–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —ç–∫—Ä–∞–Ω–∞ */
        display: flex;
        flex-direction: column;
    }
    
    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
    .container-fluid > div:last-child {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è AG Grid */
    #alarmsGrid {
        width: 100% !important;
        min-width: 0; /* –ü–æ–∑–≤–æ–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É —Å–∂–∏–º–∞—Ç—å—Å—è */
        overflow: auto; /* –†–∞–∑—Ä–µ—à–∞–µ–º —Å–∫—Ä–æ–ª–ª –¥–ª—è resize */
        min-height: 400px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
    }
    
    /* Responsive —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 768px) {
        #alarmsGrid {
            min-height: 350px;
        }
        
        .btn-toolbar {
            flex-direction: column;
            gap: 10px;
        }
        
        .btn-toolbar .btn-group {

        }
        
        .btn-toolbar .btn {

        }
        
        /* –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö */
        .container-fluid {
            padding-left: 10px !important;
            padding-right: 10px !important;
        }
    }
    
    @media (max-width: 576px) {
        #alarmsGrid {
            min-height: 300px;
        }
        
        .d-flex.justify-content-between {
            flex-direction: column;
            gap: 15px;
        }
        
        .h2 {
            font-size: 1.5rem;
        }
        
        /* –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .container-fluid {
            padding-left: 5px !important;
            padding-right: 5px !important;
        }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
    .action-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }
    
    .action-buttons .btn {
        padding: 2px 6px;
        font-size: 12px;
    }
    
    /* Responsive –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
    @media (max-width: 576px) {
        .action-buttons {
            flex-direction: column;
            gap: 2px;
        }
        
        .action-buttons .btn {
            text-align: center;
        }
        
        /* Responsive –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .h2 {
            font-size: 1.5rem;
        }
        
        /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ –∫–Ω–æ–ø–æ–∫ */
        .d-flex.align-items-center .h2 {
            line-height: 1.2;
            margin-bottom: 0;
        }
        
        .d-flex.align-items-center .btn-toolbar {
            margin-bottom: 0;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ö–∏–Ω—Ç–æ–≤ (tooltips) */
        .ag-cell[title] {
            cursor: help;
        }
        
        .description-cell[data-tooltip] {
            cursor: help;
            position: relative;
        }
        
        /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ö–∏–Ω—Ç–æ–≤ */
        .ag-cell[title]:hover::after {
            content: attr(title);
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 300px;
            white-space: pre-wrap;
            word-wrap: break-word;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ö–∏–Ω—Ç–æ–≤ –≤ —è—á–µ–π–∫–∞—Ö –æ–ø–∏—Å–∞–Ω–∏—è */
        .description-cell[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 300px;
            white-space: pre-wrap;
            word-wrap: break-word;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            top: 100%;
            left: 0;
            margin-top: 5px;
        }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ */
    .priority-high {
        color: #dc3545;
        font-weight: bold;
    }
    

    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —è—á–µ–µ–∫ —Å –¥–ª–∏–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º */
    .description-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }
    
    /* –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã —É —Å–æ–æ–±—â–µ–Ω–∏–π */
    .alert {
        margin-bottom: 0.5rem;
    }
    
    /* –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã —É –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ */
    .container-fluid > *:first-child {
        margin-top: 0;
        padding-top: 0;
    }
    
    /* –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã —É –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ main-content */
    .main-content > *:first-child {
        margin-top: 0;
        padding-top: 0;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è AG Grid —è—á–µ–µ–∫ */
    .ag-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .priority-medium {
        color: #fd7e14;
        font-weight: bold;
    }
    
    .priority-low {
        color: #28a745;
        font-weight: bold;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–ª–∞—Å—Å–æ–≤ —Ç—Ä–µ–≤–æ–≥ */
    .alarm-class-critical {
        background-color: #dc3545;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
    }
    
    .alarm-class-warning {
        background-color: #fd7e14;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
    }
    
    .alarm-class-info {
        background-color: #17a2b8;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
    }
    
    /* Responsive –∫–ª–∞—Å—Å—ã —Ç—Ä–µ–≤–æ–≥ */
    @media (max-width: 576px) {
        .alarm-class-critical,
        .alarm-class-warning,
        .alarm-class-info {
            font-size: 10px;
            padding: 1px 4px;
        }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è */
    .description-cell {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* Responsive –æ–ø–∏—Å–∞–Ω–∏–µ */
    @media (max-width: 768px) {
        .description-cell {
            max-width: 200px;
        }
    }
    
    @media (max-width: 576px) {
        .description-cell {
            max-width: 150px;
        }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–∞—Ç */
    .date-cell {
        font-size: 12px;
        color: #666;
    }
    
    /* Responsive –¥–∞—Ç—ã */
    @media (max-width: 576px) {
        .date-cell {
            font-size: 10px;
        }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ */
    .ag-pinned-left-header,
    .ag-pinned-right-header {
        background-color: #f8f9fa !important;
        border-right: 2px solid #dee2e6 !important;
        border-left: 2px solid #dee2e6 !important;
    }
    
    .ag-pinned-left-cols-container,
    .ag-pinned-right-cols-container {
        background-color: #f8f9fa !important;
        border-right: 2px solid #dee2e6 !important;
        border-left: 2px solid #dee2e6 !important;
    }
    
    /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –º–µ–∂–¥—É –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–º–∏ –∏ –æ–±—ã—á–Ω—ã–º–∏ —Å—Ç–æ–ª–±—Ü–∞–º–∏ */
    .ag-pinned-left-cols-container::after {
        content: '';
        position: absolute;
        right: -2px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #dee2e6, #adb5bd);
        z-index: 10;
    }
    
    .ag-pinned-right-cols-container::before {
        content: '';
        position: absolute;
        left: -2px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #dee2e6, #adb5bd);
        z-index: 10;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é */
    .custom-context-menu {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 14px;
    }
    
    .context-menu-item:hover {
        background-color: #e9ecef !important;
    }
    
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö */
    .ag-header-cell-pinned-left::after {
        content: 'üìå';
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px;
        opacity: 0.7;
    }
    
    .ag-header-cell-pinned-right::after {
        content: 'üìå';
        position: absolute;
        left: 5px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px;
        opacity: 0.7;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–∏/–æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–∏–∏ */
    .ag-pinned-left-cols-container,
    .ag-pinned-right-cols-container {
        transition: all 0.3s ease;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è */
    .pin-buttons .btn {
        transition: all 0.2s ease;
    }
    
    .pin-buttons .btn:hover {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ */
    @media (max-width: 768px) {
        .ag-pinned-left-cols-container,
        .ag-pinned-right-cols-container {
            max-width: 200px;
        }
    }
    
    @media (max-width: 576px) {
        .ag-pinned-left-cols-container,
        .ag-pinned-right-cols-container {
            max-width: 150px;
        }
        
        .ag-header-cell-pinned-left::after,
        .ag-header-cell-pinned-right::after {
            font-size: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-2 border-bottom" style="min-height: 80px;">
    <h1 class="h2 mb-0 d-flex align-items-center">
        <i class="bi bi-exclamation-triangle me-2"></i>–¢—Ä–µ–≤–æ–≥–∏
    </h1>
    <div class="btn-toolbar mb-0 d-flex align-items-center">
        <div class="btn-group me-2">
            <a href="{% url 'alarms:alarm_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–≤–æ–≥—É
            </a>
        </div>
    </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è AG Grid -->
<div id="alarmsGrid" class="ag-theme-alpine" style="flex: 1;"></div>

<!-- AG Grid JavaScript -->
<script src="{% static 'libs/ag-grid/js/ag-grid-community.min.js' %}"></script>
<!-- –†—É—Å—Å–∫–∞—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è AG Grid -->
<script src="{% static 'js/ag-grid-russian-locale.js' %}"></script>

<script>
// –î–∞–Ω–Ω—ã–µ –¥–ª—è AG Grid
const alarmData = {{ alarm_data|safe }};



// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö
function calculateColumnWidth(field, data, minWidth = 50, maxWidth = 300) {
    if (!data || data.length === 0) return minWidth;
    
    let maxLength = 0;
    data.forEach(row => {
        if (row[field]) {
            const length = String(row[field]).length;
            maxLength = Math.max(maxLength, length);
        }
    });
    
    // –ü—Ä–∏–º–µ—Ä–Ω–∞—è —à–∏—Ä–∏–Ω–∞: 8px –Ω–∞ —Å–∏–º–≤–æ–ª + –æ—Ç—Å—Ç—É–ø—ã
    const calculatedWidth = Math.max(minWidth, Math.min(maxWidth, maxLength * 8 + 20));
    return calculatedWidth;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
function getColumnDefs() {
    const isMobile = window.innerWidth <= 576;
    const isTablet = window.innerWidth <= 768;
    
    return [
        { 
            headerName: 'ID', 
            field: 'id', 
            width: calculateColumnWidth('id', alarmData, 50, 80),
            sortable: true, 
            filter: true,
            pinned: 'left',
            hide: isMobile, // –°–∫—Ä—ã–≤–∞–µ–º ID –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
            suppressSizeToFit: false
        },
        { 
            headerName: '–ö–∞–Ω–∞–ª', 
            field: 'channel', 
            width: calculateColumnWidth('channel', alarmData, 80, 200),
            sortable: true, 
            filter: true,
            cellRenderer: function(params) {
                const value = params.value;
                return value ? `<code>${value}</code>` : '<em class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω</em>';
            }
        },
        { 
            headerName: '–°–æ–æ–±—â–µ–Ω–∏–µ', 
            field: 'message', 
            width: calculateColumnWidth('message', alarmData, 120, 300),
            sortable: true, 
            filter: true,
            cellRenderer: function(params) {
                const value = params.value;
                if (value) {
                    const shortValue = value.length > 50 ? value.substring(0, 50) + '...' : value;
                    return `<div class="description-cell" data-tooltip="${value}">${shortValue}</div>`;
                }
                return '<em class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω–æ</em>';
            }
        },
        { 
            headerName: '–¢–∞–±–ª–∏—Ü–∞', 
            field: 'table', 

            sortable: true, 
            filter: true,
            hide: isMobile, // –°–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö

            cellRenderer: function(params) {
                const value = params.value;
                return value ? `<span class="badge bg-info">${value}</span>` : '<em class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω–∞</em>';
            }
        },
        { 
            headerName: '–ö–ª–∞—Å—Å —Ç—Ä–µ–≤–æ–≥–∏', 
            field: 'alarm_class', 

            sortable: true, 
            filter: true,

            cellRenderer: function(params) {
                const value = params.value;
                if (!value) return '<em class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω</em>';
                
                let badgeClass = 'alarm-class-info';
                if (value === '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è' || value === '–ê–≤–∞—Ä–∏—è') {
                    badgeClass = 'alarm-class-critical';
                } else if (value === '–í–∞–∂–Ω–∞—è' || value === '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ') {
                    badgeClass = 'alarm-class-warning';
                }
                
                return `<span class="${badgeClass}">${value}</span>`;
            }
        },
        { 
            headerName: '–°–ø–æ—Å–æ–± –Ω–∞–±–ª—é–¥–µ–Ω–∏—è', 
            field: 'logic', 

            sortable: true, 
            filter: true,
            hide: isMobile, // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–æ—Å–æ–± –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö

        },
        { 
            headerName: '–°–ø–æ—Å–æ–± –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è', 
            field: 'confirm_method', 

            sortable: true, 
            filter: true,
            hide: isMobile, // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–æ—Å–æ–± –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö

        },
        { 
            headerName: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', 
            field: 'priority', 

            sortable: true, 
            filter: true,

            cellRenderer: function(params) {
                const priority = params.value;
                let color = 'black';
                if (priority >= 800) color = 'red';
                else if (priority >= 500) color = 'orange';
                else if (priority >= 300) color = 'blue';
                return `<span style="color: ${color}; font-weight: bold;">${priority}</span>`;
            }
        },
        { 
            headerName: '–¢–∏–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è', 
            field: 'limit_type', 

            sortable: true, 
            filter: true,
            hide: isMobile, // –°–∫—Ä—ã–≤–∞–µ–º —Ç–∏–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö

        },
        { 
            headerName: '–¢–∏–ø –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–µ–¥–µ–ª–æ–≤', 
            field: 'limit_config_type', 

            sortable: true, 
            filter: true,
            hide: isMobile, // –°–∫—Ä—ã–≤–∞–µ–º —Ç–∏–ø –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–µ–¥–µ–ª–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö

        },
        { 
            headerName: '–ù–∏–∂–Ω–∏–π –ø—Ä–µ–¥–µ–ª', 
            field: 'low_limit', 

            sortable: true, 
            filter: true,
            hide: isMobile, // –°–∫—Ä—ã–≤–∞–µ–º –Ω–∏–∂–Ω–∏–π –ø—Ä–µ–¥–µ–ª –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö

            cellRenderer: function(params) {
                const value = params.value;
                return value !== null && value !== undefined ? value : '<em class="text-muted">-</em>';
            }
        },
        { 
            headerName: '–í–µ—Ä—Ö–Ω–∏–π –ø—Ä–µ–¥–µ–ª', 
            field: 'high_limit', 

            sortable: true, 
            filter: true,
            hide: isMobile, // –°–∫—Ä—ã–≤–∞–µ–º –≤–µ—Ä—Ö–Ω–∏–π –ø—Ä–µ–¥–µ–ª –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö

            cellRenderer: function(params) {
                const value = params.value;
                return value !== null && value !== undefined ? value : '<em class="text-muted">-</em>';
            }
        },
        { 
            headerName: '–ö–∞–Ω–∞–ª –Ω–∏–∂–Ω–µ–≥–æ –ø—Ä–µ–¥–µ–ª–∞', 
            field: 'ch_low', 

            sortable: true, 
            filter: true,
            hide: isMobile, // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞–Ω–∞–ª –Ω–∏–∂–Ω–µ–≥–æ –ø—Ä–µ–¥–µ–ª–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö

            cellRenderer: function(params) {
                const value = params.value;
                return value ? `<code>${value}</code>` : '<em class="text-muted">-</em>';
            }
        },
        { 
            headerName: '–ö–∞–Ω–∞–ª –≤–µ—Ä—Ö–Ω–µ–≥–æ –ø—Ä–µ–¥–µ–ª–∞', 
            field: 'ch_high', 

            sortable: true, 
            filter: true,
            hide: isMobile, // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞–Ω–∞–ª –≤–µ—Ä—Ö–Ω–µ–≥–æ –ø—Ä–µ–¥–µ–ª–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö

            cellRenderer: function(params) {
                const value = params.value;
                return value ? `<code>${value}</code>` : '<em class="text-muted">-</em>';
            }
        },
        { 
            headerName: '–ì–∏—Å—Ç–µ—Ä–µ–∑–∏—Å –Ω–∏–∂–Ω–∏–π', 
            field: 'hyst_low', 

            sortable: true, 
            filter: true,
            hide: isMobile, // –°–∫—Ä—ã–≤–∞–µ–º –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å –Ω–∏–∂–Ω–∏–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö

            cellRenderer: function(params) {
                const value = params.value;
                return value !== null && value !== undefined ? value : '<em class="text-muted">-</em>';
            }
        },
        { 
            headerName: '–ì–∏—Å—Ç–µ—Ä–µ–∑–∏—Å –≤–µ—Ä—Ö–Ω–∏–π', 
            field: 'hyst_high', 

            sortable: true, 
            filter: true,
            hide: isMobile, // –°–∫—Ä—ã–≤–∞–µ–º –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å –≤–µ—Ä—Ö–Ω–∏–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö

            cellRenderer: function(params) {
                const value = params.value;
                return value !== null && value !== undefined ? value : '<em class="text-muted">-</em>';
            }
        },
        { 
            headerName: '–î–∏—Å–∫—Ä–µ—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ', 
            field: 'discrete_val', 

            sortable: true, 
            filter: true,
            hide: isMobile, // –°–∫—Ä—ã–≤–∞–µ–º –¥–∏—Å–∫—Ä–µ—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö

            cellRenderer: function(params) {
                const value = params.value;
                return value !== null && value !== undefined ? value : '<em class="text-muted">-</em>';
            }
        },
        { 
            headerName: '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è', 
            field: 'created_at', 

            sortable: true, 
            filter: true,
            hide: isMobile, // –°–∫—Ä—ã–≤–∞–µ–º –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö

            cellRenderer: function(params) {
                return `<div class="date-cell">${params.value}</div>`;
            }
        },
        { 
            headerName: '–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 
            field: 'updated_at', 

            sortable: true, 
            filter: true,
            hide: isMobile, // –°–∫—Ä—ã–≤–∞–µ–º –¥–∞—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö

            cellRenderer: function(params) {
                return `<div class="date-cell">${params.value}</div>`;
            }
        },
        {
            headerName: '–î–µ–π—Å—Ç–≤–∏—è',
            field: 'actions',

            sortable: false,
            filter: false,

            cellRenderer: function(params) {
                const alarmId = params.data.id;
                return `
                    <div class="action-buttons">
                        <a href="/alarms/${alarmId}/edit/" class="btn btn-sm btn-outline-primary me-1" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <a href="/alarms/${alarmId}/delete/" class="btn btn-sm btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å">
                            <i class="bi bi-trash"></i>
                        </a>
                    </div>
                `;
            }
        }
    ];
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ö–∏–Ω—Ç–æ–≤
function createCustomTooltips() {
    const tooltipElements = document.querySelectorAll('[data-tooltip]');
    tooltipElements.forEach(element => {
        element.addEventListener('mouseenter', function(e) {
            const tooltipText = this.getAttribute('data-tooltip');
            if (!tooltipText) return;
            
            const tooltip = document.createElement('div');
            tooltip.className = 'custom-tooltip';
            tooltip.textContent = tooltipText;
            tooltip.style.cssText = `
                position: absolute;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 12px;
                max-width: 300px;
                white-space: pre-wrap;
                word-wrap: break-word;
                z-index: 1000;
                pointer-events: none;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                top: ${e.pageY + 10}px;
                left: ${e.pageX + 10}px;
            `;
            
            document.body.appendChild(tooltip);
            this._tooltip = tooltip;
        });
        
        element.addEventListener('mouseleave', function() {
            if (this._tooltip) {
                this._tooltip.remove();
                this._tooltip = null;
            }
        });
    });
}

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è AG Grid
const gridOptions = {
    theme: 'legacy',
    columnDefs: getColumnDefs(),
    rowData: alarmData,
    domLayout: 'normal', // –ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –≤—ã—Å–æ—Ç—ã –ø–æ–¥ —ç–∫—Ä–∞–Ω
    suppressColumnVirtualisation: false,
    suppressRowVirtualisation: false,
    defaultColDef: { 
        sortable: true, 
        filter: true, 
        resizable: true,
        minWidth: 50,
        maxWidth: 300, // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
        suppressSizeToFit: false,
        autoHeight: true,
        // –í–∫–ª—é—á–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤
        lockPinned: false
    },
    pagination: true,
    paginationPageSize: 20,
    paginationPageSizeSelector: [10, 20, 50, 100],
    multiSortKey: 'ctrl',
    rowSelection: { type: 'multiple' }, // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º deprecated warning
    animateRows: true,
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä—É—Å—Å–∫—É—é –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é
    localeText: agGridRussianLocale,
    onGridReady: function(params) {
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
        const header = document.querySelector('.btn-toolbar');
        if (header && !document.querySelector('.export-buttons')) {
            const exportGroup = document.createElement('div');
            exportGroup.className = 'btn-group me-2 export-buttons';
            exportGroup.innerHTML = `
                <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-download"></i> –≠–∫—Å–ø–æ—Ä—Ç
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="exportToExcel()">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportToCsv()">
                        <i class="bi bi-file-earmark-text"></i> CSV
                    </a></li>
                </ul>
            `;
            header.insertBefore(exportGroup, header.firstChild);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ–º —Å—Ç–æ–ª–±—Ü–æ–≤
        if (header && !document.querySelector('.pin-buttons')) {
            const pinGroup = document.createElement('div');
            pinGroup.className = 'btn-group me-2 pin-buttons';
            pinGroup.innerHTML = `
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-pin-angle"></i> –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="pinAllLeft()">
                        <i class="bi bi-pin-angle-fill"></i> –ó–∞–∫—Ä–µ–ø–∏—Ç—å –≤—Å–µ —Å–ª–µ–≤–∞
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="pinAllRight()">
                        <i class="bi bi-pin-angle-fill"></i> –ó–∞–∫—Ä–µ–ø–∏—Ç—å –≤—Å–µ —Å–ø—Ä–∞–≤–∞
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="unpinAll()">
                        <i class="bi bi-pin-angle"></i> –û—Ç–∫—Ä–µ–ø–∏—Ç—å –≤—Å–µ
                    </a></li>
                </ul>
            `;
            const exportGroup = document.querySelector('.export-buttons');
            if (exportGroup) {
                header.insertBefore(pinGroup, exportGroup);
            } else {
                header.insertBefore(pinGroup, header.firstChild);
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
        if (header && !document.querySelector('.test-menu-button')) {
            const testButton = document.createElement('button');
            testButton.className = 'btn btn-outline-warning me-2 test-menu-button';
            testButton.innerHTML = '<i class="bi bi-bug"></i> –¢–µ—Å—Ç –º–µ–Ω—é';
            testButton.onclick = function() {
                console.log('üß™ –¢–µ—Å—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞');
                const columns = gridOptions.api.getAllDisplayedColumns();
                if (columns.length > 0) {
                    const firstColumn = columns[0];
                    console.log('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –º–µ–Ω—é –¥–ª—è —Å—Ç–æ–ª–±—Ü–∞:', firstColumn.getColId());
                    
                    // –°–æ–∑–¥–∞–µ–º —Ñ–µ–π–∫–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
                    const fakeEvent = {
                        pageX: 100,
                        pageY: 100,
                        preventDefault: () => {},
                        stopPropagation: () => {}
                    };
                    
                    showColumnContextMenu(fakeEvent, firstColumn);
                } else {
                    console.warn('‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                }
            };
            const exportGroup = document.querySelector('.export-buttons');
            if (exportGroup) {
                header.insertBefore(testButton, exportGroup);
            } else {
                header.insertBefore(testButton, header.firstChild);
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å—Ç–æ–ª–±—Ü–æ–≤
        setTimeout(() => {
            addColumnHeaderContextMenu();
        }, 500);
    },
    onFirstDataRendered: function(params) {
        const rowCount = params.api.getDisplayedRowCount();
        if (rowCount > 0) {
            setTimeout(() => {
                const columns = params.api.getAllDisplayedColumns();
                if (columns.length > 0) {
                    try {
                        const columnIds = columns.map(col => col.getColId());
                        params.api.autoSizeColumns(columnIds);
                    } catch (error) {
                        params.api.sizeColumnsToFit();
                    }
                }
                
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Ö–∏–Ω—Ç—ã
                setTimeout(() => {
                    createCustomTooltips();
                }, 100);
            }, 200);
        }
    },
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤
    onColumnPinned: function(params) {
        console.log('–°—Ç–æ–ª–±–µ—Ü –∑–∞–∫—Ä–µ–ø–ª–µ–Ω:', params.column.getColId(), '–ø–æ–∑–∏—Ü–∏—è:', params.pinned);
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ localStorage
        saveColumnPinningState();
    }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º —Å—Ç–æ–ª–±—Ü–æ–≤
function addColumnHeaderContextMenu() {
    console.log('üîç –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å—Ç–æ–ª–±—Ü–æ–≤...');
    
    const gridElement = document.querySelector('#alarmsGrid');
    if (!gridElement) {
        console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç #alarmsGrid –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    console.log('‚úÖ –≠–ª–µ–º–µ–Ω—Ç #alarmsGrid –Ω–∞–π–¥–µ–Ω');
    
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤
    const headerCells = gridElement.querySelectorAll('.ag-header-cell');
    console.log(`üìä –ù–∞–π–¥–µ–Ω–æ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å—Ç–æ–ª–±—Ü–æ–≤: ${headerCells.length}`);
    
    headerCells.forEach((headerCell, index) => {
        console.log(`üìå –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ ${index + 1}:`, headerCell);
        
        // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø–æ –ø—Ä–∞–≤–æ–º—É –∫–ª–∏–∫—É
        headerCell.addEventListener('contextmenu', function(event) {
            console.log('üñ±Ô∏è –ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–µ —Å—Ç–æ–ª–±—Ü–∞');
            event.preventDefault();
            event.stopPropagation();
            
            // –ü–æ–ª—É—á–∞–µ–º ID —Å—Ç–æ–ª–±—Ü–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            const columnId = this.getAttribute('col-id');
            console.log('üîç ID —Å—Ç–æ–ª–±—Ü–∞:', columnId);
            
            if (!columnId) {
                console.warn('‚ö†Ô∏è ID —Å—Ç–æ–ª–±—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º —Å—Ç–æ–ª–±–µ—Ü –≤ AG Grid
            const column = gridOptions.api.getColumn(columnId);
            if (!column) {
                console.warn('‚ö†Ô∏è –°—Ç–æ–ª–±–µ—Ü –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ API');
                return;
            }
            
            console.log('‚úÖ –°—Ç–æ–ª–±–µ—Ü –Ω–∞–π–¥–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é');
            showColumnContextMenu(event, column);
        });
        
        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é –ø–æ –¥–≤–æ–π–Ω–æ–º—É –∫–ª–∏–∫—É
        headerCell.addEventListener('dblclick', function(event) {
            console.log('üñ±Ô∏è –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–µ —Å—Ç–æ–ª–±—Ü–∞');
            event.preventDefault();
            event.stopPropagation();
            
            // –ü–æ–ª—É—á–∞–µ–º ID —Å—Ç–æ–ª–±—Ü–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            const columnId = this.getAttribute('col-id');
            console.log('üîç ID —Å—Ç–æ–ª–±—Ü–∞:', columnId);
            
            if (!columnId) {
                console.warn('‚ö†Ô∏è ID —Å—Ç–æ–ª–±—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º —Å—Ç–æ–ª–±–µ—Ü –≤ AG Grid
            const column = gridOptions.api.getColumn(columnId);
            if (!column) {
                console.warn('‚ö†Ô∏è –°—Ç–æ–ª–±–µ—Ü –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ API');
                return;
            }
            
            console.log('‚úÖ –°—Ç–æ–ª–±–µ—Ü –Ω–∞–π–¥–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é');
            showColumnContextMenu(event, column);
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
        headerCell.title = '–ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ –∏–ª–∏ –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –º–µ–Ω—é –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è';
        headerCell.style.cursor = 'pointer';
    });
    
    // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞–µ–º—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    const observer = new MutationObserver(function(mutations) {
        console.log('üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ DOM');
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1 && node.classList && node.classList.contains('ag-header-cell')) {
                        console.log('üìå –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–æ–ª–±—Ü–∞');
                        
                        // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø–æ –ø—Ä–∞–≤–æ–º—É –∫–ª–∏–∫—É
                        node.addEventListener('contextmenu', function(event) {
                            console.log('üñ±Ô∏è –ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ –Ω–∞ –Ω–æ–≤–æ–º –∑–∞–≥–æ–ª–æ–≤–∫–µ');
                            event.preventDefault();
                            event.stopPropagation();
                            
                            const columnId = this.getAttribute('col-id');
                            if (columnId) {
                                const column = gridOptions.api.getColumn(columnId);
                                if (column) {
                                    showColumnContextMenu(event, column);
                                }
                            }
                        });
                        
                        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é –ø–æ –¥–≤–æ–π–Ω–æ–º—É –∫–ª–∏–∫—É
                        node.addEventListener('dblclick', function(event) {
                            console.log('üñ±Ô∏è –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ –Ω–æ–≤–æ–º –∑–∞–≥–æ–ª–æ–≤–∫–µ');
                            event.preventDefault();
                            event.stopPropagation();
                            
                            const columnId = this.getAttribute('col-id');
                            if (columnId) {
                                const column = gridOptions.api.getColumn(columnId);
                                if (column) {
                                    showColumnContextMenu(event, column);
                                }
                            }
                        });
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
                        node.title = '–ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ –∏–ª–∏ –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –º–µ–Ω—é –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è';
                        node.style.cursor = 'pointer';
                    }
                });
            }
        });
    });
    
    observer.observe(gridElement, { childList: true, subtree: true });
    console.log('‚úÖ MutationObserver –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ–º —Å—Ç–æ–ª–±—Ü–æ–≤
function showColumnContextMenu(event, column) {
    console.log('üéØ showColumnContextMenu –≤—ã–∑–≤–∞–Ω–∞');
    console.log('üìä –°—Ç–æ–ª–±–µ—Ü:', column);
    console.log('üñ±Ô∏è –°–æ–±—ã—Ç–∏–µ:', event);
    
    event.preventDefault();
    event.stopPropagation();
    
    const menu = document.createElement('div');
    menu.className = 'custom-context-menu';
    menu.style.cssText = `
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        z-index: 1000;
        padding: 5px 0;
        min-width: 150px;
        top: ${event.pageY}px;
        left: ${event.pageX}px;
    `;
    
    const currentPinned = column.getPinned();
    console.log('üìå –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è:', currentPinned);
    
    const menuItems = [
        { text: '–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å–ª–µ–≤–∞', action: () => pinColumn(column, 'left'), 
          disabled: currentPinned === 'left', icon: 'bi-pin-angle-fill' },
        { text: '–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å–ø—Ä–∞–≤–∞', action: () => pinColumn(column, 'right'), 
          disabled: currentPinned === 'right', icon: 'bi-pin-angle-fill' },
        { text: '–û—Ç–∫—Ä–µ–ø–∏—Ç—å', action: () => pinColumn(column, null), 
          disabled: currentPinned === null, icon: 'bi-pin-angle' }
    ];
    
    console.log('üìã –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –º–µ–Ω—é:', menuItems.length);
    
    menuItems.forEach((item, index) => {
        console.log(`üìå –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –º–µ–Ω—é ${index + 1}:`, item.text);
        
        const menuItem = document.createElement('div');
        menuItem.className = 'context-menu-item';
        menuItem.style.cssText = `
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            ${item.disabled ? 'opacity: 0.5; cursor: not-allowed;' : ''}
        `;
        menuItem.innerHTML = `
            <i class="bi ${item.icon}"></i>
            <span>${item.text}</span>
        `;
        
        if (!item.disabled) {
            menuItem.addEventListener('click', () => {
                console.log('üñ±Ô∏è –ö–ª–∏–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É –º–µ–Ω—é:', item.text);
                item.action();
                document.body.removeChild(menu);
            });
        }
        
        menuItem.addEventListener('mouseenter', function() {
            if (!item.disabled) {
                this.style.backgroundColor = '#f8f9fa';
            }
        });
        
        menuItem.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
        
        menu.appendChild(menuItem);
    });
    
    console.log('‚úÖ –ú–µ–Ω—é —Å–æ–∑–¥–∞–Ω–æ, –¥–æ–±–∞–≤–ª—è–µ–º –≤ DOM');
    document.body.appendChild(menu);
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    setTimeout(() => {
        document.addEventListener('click', function closeMenu() {
            console.log('üñ±Ô∏è –ö–ª–∏–∫ –≤–Ω–µ –º–µ–Ω—é, –∑–∞–∫—Ä—ã–≤–∞–µ–º');
            if (document.body.contains(menu)) {
                document.body.removeChild(menu);
            }
            document.removeEventListener('click', closeMenu);
        });
    }, 0);
    
    console.log('‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø–æ–∫–∞–∑–∞–Ω–æ');
}

function pinColumn(column, pinned) {
    if (gridOptions.api) {
        gridOptions.api.setColumnPinned(column, pinned);
    }
}

function pinAllLeft() {
    if (gridOptions.api) {
        const columns = gridOptions.api.getAllDisplayedColumns();
        columns.forEach(column => {
            if (!column.getColId().includes('actions')) { // –ù–µ –∑–∞–∫—Ä–µ–ø–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü –¥–µ–π—Å—Ç–≤–∏–π
                gridOptions.api.setColumnPinned(column, 'left');
            }
        });
    }
}

function pinAllRight() {
    if (gridOptions.api) {
        const columns = gridOptions.api.getAllDisplayedColumns();
        columns.forEach(column => {
            if (!column.getColId().includes('actions')) { // –ù–µ –∑–∞–∫—Ä–µ–ø–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü –¥–µ–π—Å—Ç–≤–∏–π
                gridOptions.api.setColumnPinned(column, 'right');
            }
        });
    }
}

function unpinAll() {
    if (gridOptions.api) {
        const columns = gridOptions.api.getAllDisplayedColumns();
        columns.forEach(column => {
            gridOptions.api.setColumnPinned(column, null);
        });
    }
}

function saveColumnPinningState() {
    if (gridOptions.api) {
        const columns = gridOptions.api.getAllDisplayedColumns();
        const pinningState = {};
        
        columns.forEach(column => {
            const pinned = column.getPinned();
            if (pinned) {
                pinningState[column.getColId()] = pinned;
            }
        });
        
        localStorage.setItem('alarmGridPinningState', JSON.stringify(pinningState));
    }
}

function loadColumnPinningState() {
    const savedState = localStorage.getItem('alarmGridPinningState');
    if (savedState && gridOptions.api) {
        try {
            const pinningState = JSON.parse(savedState);
            Object.keys(pinningState).forEach(colId => {
                const column = gridOptions.api.getColumn(colId);
                if (column) {
                    gridOptions.api.setColumnPinned(column, pinningState[colId]);
                }
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è:', error);
        }
    }
}

// –§—É–Ω–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
function exportToExcel() {
    gridOptions.api.exportDataAsExcel({
        fileName: 'alarms_export.xlsx'
    });
}

function exportToCsv() {
    gridOptions.api.exportDataAsCsv({
        fileName: 'alarms_export.csv'
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AG Grid
document.addEventListener('DOMContentLoaded', function() {
    try {
        const gridDiv = document.querySelector('#alarmsGrid');
        agGrid.createGrid(gridDiv, gridOptions);
        
        // Debounce —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (gridOptions.api) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å—Ç–æ–ª–±—Ü–æ–≤
                    gridOptions.api.setColumnDefs(getColumnDefs());
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ç–∞–±–ª–∏—Ü—ã
                    gridOptions.api.sizeColumnsToFit();
                    
                    setTimeout(() => {
                        const columnIds = gridOptions.api.getAllDisplayedColumns().map(col => col.getColId());
                        if (columnIds.length > 0) {
                            gridOptions.api.autoSizeColumns(columnIds);
                        }
                    }, 50);
                }
            }, 250);
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadColumnPinningState();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ AG Grid —Ç—Ä–µ–≤–æ–≥:', error);
    }
});
</script>
{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block title %}{% include 'alarms/includes/page_title.html' with page_title="Тревоги" %}{% endblock %}

{% block extra_css %}
<!-- AG Grid CSS -->
<link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-grid.css">
<link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-theme-alpine.css">

<style>
    /* Контейнер для AG Grid */
    #alarmsGrid {
        height: 600px;
        width: 100%;
    }
    
    /* Стили для кнопок действий */
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    
    .action-buttons .btn {
        padding: 2px 6px;
        font-size: 12px;
    }
    
    /* Стили для приоритетов */
    .priority-high {
        color: #dc3545;
        font-weight: bold;
    }
    
    .priority-medium {
        color: #fd7e14;
        font-weight: bold;
    }
    
    .priority-low {
        color: #28a745;
        font-weight: bold;
    }
    
    /* Стили для описания */
    .description-cell {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* Стили для дат */
    .date-cell {
        font-size: 12px;
        color: #666;
    }
    
    /* Стили для классов тревог */
    .alarm-class-critical {
        background-color: #dc3545;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
    }
    
    .alarm-class-warning {
        background-color: #fd7e14;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
    }
    
    .alarm-class-info {
        background-color: #17a2b8;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-exclamation-triangle me-2"></i>Тревоги
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'alarms:alarm_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Добавить тревогу
            </a>
        </div>
    </div>
</div>

<!-- Контейнер для AG Grid -->
<div id="alarmsGrid" class="ag-theme-alpine"></div>

<!-- AG Grid JavaScript -->
<script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.js"></script>
<script src="{% static 'js/ag-grid-common.js' %}"></script>

<script>
// Данные для AG Grid
const alarmData = {{ alarm_data|safe }};

// Справочные данные для фильтров
const alarmClasses = {{ alarm_classes|safe }};
const logics = {{ logics|safe }};
const confirmMethods = {{ confirm_methods|safe }};
const limitTypes = {{ limit_types|safe }};

// Конфигурация колонок AG Grid
const columnDefs = [
    {
        headerName: 'ID',
        field: 'id',
        width: 80,
        sortable: true,
        filter: 'agNumberColumnFilter',
        pinned: 'left'
    },
    {
        headerName: 'Канал',
        field: 'channel',
        width: 150,
        sortable: true,
        filter: 'agTextColumnFilter',
        filterParams: {
            filterOptions: ['contains', 'startsWith', 'endsWith', 'equals']
        },
        cellRenderer: function(params) {
            const value = params.value;
            return value ? `<code>${value}</code>` : '<em class="text-muted">Не указан</em>';
        }
    },
    {
        headerName: 'Сообщение',
        field: 'message',
        width: 250,
        sortable: true,
        filter: 'agTextColumnFilter',
        cellRenderer: function(params) {
            const value = params.value;
            if (value) {
                const shortValue = value.length > 50 ? value.substring(0, 50) + '...' : value;
                return `<div class="description-cell" title="${value}">${shortValue}</div>`;
            }
            return '<em class="text-muted">Не указано</em>';
        }
    },
    {
        headerName: 'Таблица',
        field: 'table',
        width: 200,
        sortable: true,
        filter: 'agTextColumnFilter',
        cellRenderer: function(params) {
            const value = params.value;
            return value ? `<span class="badge bg-info">${value}</span>` : '<em class="text-muted">Не указана</em>';
        }
    },
    {
        headerName: 'Класс тревоги',
        field: 'alarm_class',
        width: 150,
        sortable: true,
        filter: 'agSetColumnFilter',
        filterParams: {
            values: alarmClasses
        },
        cellRenderer: function(params) {
            const value = params.value;
            if (!value) return '<em class="text-muted">Не указан</em>';
            
            let badgeClass = 'alarm-class-info';
            if (value === 'Критическая' || value === 'Авария') {
                badgeClass = 'alarm-class-critical';
            } else if (value === 'Важная' || value === 'Предупреждение') {
                badgeClass = 'alarm-class-warning';
            }
            
            return `<span class="${badgeClass}">${value}</span>`;
        }
    },
    {
        headerName: 'Способ наблюдения',
        field: 'logic',
        width: 120,
        sortable: true,
        filter: 'agSetColumnFilter',
        filterParams: {
            values: logics
        }
    },
    {
        headerName: 'Метод подтверждения',
        field: 'confirm_method',
        width: 180,
        sortable: true,
        filter: 'agSetColumnFilter',
        filterParams: {
            values: confirmMethods
        }
    },
    {
        headerName: 'Приоритет',
        field: 'priority',
        width: 100,
        sortable: true,
        filter: 'agNumberColumnFilter',
        cellRenderer: function(params) {
            const priority = params.value;
            let color = 'black';
            if (priority >= 800) color = 'red';
            else if (priority >= 500) color = 'orange';
            else if (priority >= 300) color = 'blue';
            return `<span style="color: ${color}; font-weight: bold;">${priority}</span>`;
        }
    },
    {
        headerName: 'Тип ограничения',
        field: 'limit_type',
        width: 150,
        sortable: true,
        filter: 'agSetColumnFilter',
        filterParams: {
            values: limitTypes
        }
    },
    {
        headerName: 'Пределы',
        children: [
            {
                headerName: 'Нижний',
                field: 'low_limit',
                width: 100,
                sortable: true,
                filter: 'agNumberColumnFilter',
                cellRenderer: function(params) {
                    const value = params.value;
                    return value !== null ? value : '<em class="text-muted">-</em>';
                }
            },
            {
                headerName: 'Верхний',
                field: 'high_limit',
                width: 100,
                sortable: true,
                filter: 'agNumberColumnFilter',
                cellRenderer: function(params) {
                    const value = params.value;
                    return value !== null ? value : '<em class="text-muted">-</em>';
                }
            }
        ]
    },
    {
        headerName: 'Гистерезис',
        children: [
            {
                headerName: 'Низкий',
                field: 'hyst_low',
                width: 100,
                sortable: true,
                filter: 'agNumberColumnFilter',
                cellRenderer: function(params) {
                    const value = params.value;
                    return value !== null ? value : '<em class="text-muted">-</em>';
                }
            },
            {
                headerName: 'Высокий',
                field: 'hyst_high',
                width: 100,
                sortable: true,
                filter: 'agNumberColumnFilter',
                cellRenderer: function(params) {
                    const value = params.value;
                    return value !== null ? value : '<em class="text-muted">-</em>';
                }
            }
        ]
    },
    {
        headerName: 'Дополнительно',
        children: [
            {
                headerName: 'Дискретное значение',
                field: 'discrete_val',
                width: 120,
                sortable: true,
                filter: 'agNumberColumnFilter',
                cellRenderer: function(params) {
                    const value = params.value;
                    return value !== null ? value : '<em class="text-muted">-</em>';
                }
            },
            {
                headerName: 'Канал низкий',
                field: 'ch_low',
                width: 120,
                sortable: true,
                filter: 'agTextColumnFilter',
                cellRenderer: function(params) {
                    const value = params.value;
                    return value ? `<code>${value}</code>` : '<em class="text-muted">-</em>';
                }
            },
            {
                headerName: 'Канал высокий',
                field: 'ch_high',
                width: 120,
                sortable: true,
                filter: 'agTextColumnFilter',
                cellRenderer: function(params) {
                    const value = params.value;
                    return value ? `<code>${value}</code>` : '<em class="text-muted">-</em>';
                }
            }
        ]
    },
    {
        headerName: 'Даты',
        children: [
            {
                headerName: 'Создан',
                field: 'created_at',
                width: 150,
                sortable: true,
                filter: 'agDateColumnFilter',
                cellRenderer: function(params) {
                    return `<div class="date-cell">${params.value}</div>`;
                }
            },
            {
                headerName: 'Обновлен',
                field: 'updated_at',
                width: 150,
                sortable: true,
                filter: 'agDateColumnFilter',
                cellRenderer: function(params) {
                    return `<div class="date-cell">${params.value}</div>`;
                }
            }
        ]
    },
    {
        headerName: 'Действия',
        field: 'actions',
        width: 100,
        sortable: false,
        filter: false,
        cellRenderer: function(params) {
            const alarmId = params.data.id;
            return `
                <div class="action-buttons">
                    <a href="/alarms/${alarmId}/edit/" class="btn btn-sm btn-outline-primary me-1" title="Редактировать">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <a href="/alarms/${alarmId}/delete/" class="btn btn-sm btn-outline-danger" title="Удалить">
                        <i class="bi bi-trash"></i>
                    </a>
                </div>
            `;
        }
    }
];

// Создаем конфигурацию AG Grid
const gridOptions = createGridConfig('alarms', columnDefs, alarmData);

// Инициализация AG Grid
document.addEventListener('DOMContentLoaded', function() {
    initAgGrid('alarmsGrid', gridOptions);
});
</script>
{% endblock %}
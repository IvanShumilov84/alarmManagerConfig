{% extends 'base.html' %}

{% block title %}Аварийные сигналы - Система управления аварийными сигналами{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-exclamation-triangle"></i> Аварийные сигналы
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2" role="group">
            <a href="?display_mode=compact{% for field in sort_fields %}&sort_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for order in sort_orders %}&order_{{ forloop.counter0 }}={{ order }}{% endfor %}{% for field in filter_fields %}&filter_field_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for op in filter_ops %}&filter_op_{{ forloop.counter0 }}={{ op }}{% endfor %}{% for value in filter_values %}&filter_value_{{ forloop.counter0 }}={{ value }}{% endfor %}" class="btn btn-outline-secondary keep-filters {% if display_mode == 'compact' %}active{% endif %}">
                <i class="bi bi-list"></i> Компактно
            </a>
            <a href="?display_mode=full{% for field in sort_fields %}&sort_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for order in sort_orders %}&order_{{ forloop.counter0 }}={{ order }}{% endfor %}{% for field in filter_fields %}&filter_field_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for op in filter_ops %}&filter_op_{{ forloop.counter0 }}={{ op }}{% endfor %}{% for value in filter_values %}&filter_value_{{ forloop.counter0 }}={{ value }}{% endfor %}" class="btn btn-outline-secondary keep-filters {% if display_mode == 'full' %}active{% endif %}">
                <i class="bi bi-card-text"></i> Полно
            </a>
        </div>
        <a href="{% url 'alarms:alarm_create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Добавить сигнал
        </a>
    </div>
</div>

<!-- ФИЛЬТРЫ -->
<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" onclick="toggleFilterSettings()">
        <div class="d-flex align-items-center">
            <h6 class="mb-0">
                <i class="bi bi-funnel"></i> Настройка фильтрации
            </h6>
            <span id="filtersActiveNotice" class="badge bg-danger ms-2" style="display:none">Фильтрация активна</span>
        </div>
        <i class="bi bi-chevron-down" id="filterToggleIcon"></i>
    </div>
    <div class="card-body" id="filterSettingsBody">
        <div id="filterForm">
            <div class="row" id="filterFields">
                <!-- JS вставит фильтры -->
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-12">
                <a href="#" class="btn btn-sm btn-outline-secondary me-2" id="clearFiltersBtn" onclick="event.preventDefault(); console.log('Кнопка нажата через onclick'); clearFilters(); return false;">
                    <i class="bi bi-x"></i> Очистить все фильтры
                </a>
                <button type="button" class="btn btn-sm btn-outline-success me-2" onclick="addFilterField()">
                    <i class="bi bi-plus"></i> Добавить фильтр
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary" id="applyFiltersBtn">
                    <i class="bi bi-check"></i> Применить фильтры
                </button>
            </div>
        </div>
    </div>
</div>

<!-- СОРТИРОВКА -->
<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" onclick="toggleSortSettings()">
        <div class="d-flex align-items-center">
            <h6 class="mb-0">
                <i class="bi bi-sort-down"></i> Настройка сортировки
            </h6>
            <span id="sortActiveNotice" class="badge bg-danger ms-2" style="display:none">Сортировка активна</span>
        </div>
        <i class="bi bi-chevron-down" id="sortToggleIcon"></i>
    </div>
    <div class="card-body" id="sortSettingsBody">
        <form method="get" id="sortForm">
            <input type="hidden" name="display_mode" value="{{ display_mode }}">
            <div class="row" id="sortFields">
                <div class="col-md-4 mb-2">
                    <select name="sort_0" class="form-select form-select-sm sort-field">
                        <option value="">Выберите поле</option>
                        <option value="id" {% if 'id' in sort_fields %}selected{% endif %}>ID</option>
                        <option value="alarm_class" {% if 'alarm_class' in sort_fields %}selected{% endif %}>Класс</option>
                        <option value="table" {% if 'table' in sort_fields %}selected{% endif %}>Таблица</option>
                        <option value="logic" {% if 'logic' in sort_fields %}selected{% endif %}>Логика</option>
                        <option value="channel" {% if 'channel' in sort_fields %}selected{% endif %}>Канал</option>
                        <option value="msg" {% if 'msg' in sort_fields %}selected{% endif %}>Сообщение</option>
                        <option value="prior" {% if 'prior' in sort_fields %}selected{% endif %}>Приоритет</option>
                        <option value="created_at" {% if 'created_at' in sort_fields %}selected{% endif %}>Дата создания</option>
                        <option value="updated_at" {% if 'updated_at' in sort_fields %}selected{% endif %}>Дата обновления</option>
                    </select>
                </div>
                <div class="col-md-3 mb-2">
                    <select name="order_0" class="form-select form-select-sm sort-order">
                        <option value="asc" {% if 'asc' in sort_orders %}selected{% endif %}>По возрастанию</option>
                        <option value="desc" {% if 'desc' in sort_orders %}selected{% endif %}>По убыванию</option>
                    </select>
                </div>
                <div class="col-md-2 mb-2">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSortField()">
                        <i class="bi bi-plus"></i> Добавить
                    </button>
                </div>
                <div class="col-md-2 mb-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSort()">
                        <i class="bi bi-x"></i> Очистить
                    </button>
                </div>
            </div>
            
            {% if sort_fields %}
            <div class="mt-2">
                <small class="text-muted">
                    <strong>Текущая сортировка:</strong> <span id="currentSortDisplay">Настроена</span>
                </small>
            </div>
            {% endif %}
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if alarms %}
            {% if display_mode == 'compact' %}
                <!-- Компактное отображение -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>
                                    ID
                                    {% if 'id' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.id == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th>
                                    Класс
                                    {% if 'alarm_class' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.alarm_class == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th>
                                    Таблица
                                    {% if 'table' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.table == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th>
                                    Логика
                                    {% if 'logic' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.logic == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th>
                                    Канал
                                    {% if 'channel' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.channel == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th>
                                    Сообщение
                                    {% if 'msg' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.msg == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th>
                                    Приоритет
                                    {% if 'prior' in sort_indicators %}
                                        <i class="bi bi-arrow-{% if sort_indicators.prior == 'asc' %}up{% else %}down{% endif %}"></i>
                                    {% endif %}
                                </th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alarm in alarms %}
                            <tr>
                                <td>{{ alarm.id }}</td>
                                <td>
                                    <span class="badge bg-{% if alarm.alarm_class == 'error' %}danger{% elif alarm.alarm_class == 'warn' %}warning{% elif alarm.alarm_class == 'info' %}info{% else %}secondary{% endif %}">
                                        {{ alarm.get_alarm_class_display }}
                                    </span>
                                </td>
                                <td>{{ alarm.table.name }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ alarm.get_logic_display }}</span>
                                </td>
                                <td>
                                    {% if alarm.channel %}
                                        <code>{{ alarm.channel }}</code>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ alarm.msg|truncatechars:60 }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ alarm.prior }}</span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'alarms:alarm_edit' alarm.pk %}" 
                                           class="btn btn-sm btn-outline-primary" 
                                           title="Редактировать">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{% url 'alarms:alarm_delete' alarm.pk %}" 
                                           class="btn btn-sm btn-outline-danger" 
                                           title="Удалить"
                                           onclick="return confirm('Вы уверены, что хотите удалить этот аварийный сигнал?')">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <!-- Полное отображение -->
                <div class="row">
                    {% for alarm in alarms %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <span class="badge bg-{% if alarm.alarm_class == 'error' %}danger{% elif alarm.alarm_class == 'warn' %}warning{% elif alarm.alarm_class == 'info' %}info{% else %}secondary{% endif %} me-2">
                                        {{ alarm.get_alarm_class_display }}
                                    </span>
                                    ID: {{ alarm.id }}
                                </h6>
                                <div class="btn-group" role="group">
                                    <a href="{% url 'alarms:alarm_edit' alarm.pk %}" 
                                       class="btn btn-sm btn-outline-primary" 
                                       title="Редактировать">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a href="{% url 'alarms:alarm_delete' alarm.pk %}" 
                                       class="btn btn-sm btn-outline-danger" 
                                       title="Удалить"
                                       onclick="return confirm('Вы уверены, что хотите удалить этот аварийный сигнал?')">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Таблица:</strong></div>
                                    <div class="col-8">{{ alarm.table.name }}</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Логика:</strong></div>
                                    <div class="col-8">
                                        <span class="badge bg-primary">{{ alarm.get_logic_display }}</span>
                                    </div>
                                </div>
                                {% if alarm.channel %}
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Канал:</strong></div>
                                    <div class="col-8"><code>{{ alarm.channel }}</code></div>
                                </div>
                                {% endif %}
                                {% if alarm.limit_type %}
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Тип лимита:</strong></div>
                                    <div class="col-8">{{ alarm.get_limit_type_display }}</div>
                                </div>
                                {% endif %}
                                {% if alarm.low or alarm.high %}
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Лимиты:</strong></div>
                                    <div class="col-8">
                                        {% if alarm.low %}<div>Низкий: {{ alarm.low }}</div>{% endif %}
                                        {% if alarm.high %}<div>Высокий: {{ alarm.high }}</div>{% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                {% if alarm.discrete_val %}
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Дискретное значение:</strong></div>
                                    <div class="col-8">{{ alarm.discrete_val }}</div>
                                </div>
                                {% endif %}
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Сообщение:</strong></div>
                                    <div class="col-8">{{ alarm.msg }}</div>
                                </div>
                                {% if alarm.hyst_low or alarm.hyst_high %}
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Гистерезис:</strong></div>
                                    <div class="col-8">
                                        {% if alarm.hyst_low %}<div>Низкий: {{ alarm.hyst_low }}</div>{% endif %}
                                        {% if alarm.hyst_high %}<div>Высокий: {{ alarm.hyst_high }}</div>{% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                {% if alarm.ch_low or alarm.ch_high %}
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Каналы гистерезиса:</strong></div>
                                    <div class="col-8">
                                        {% if alarm.ch_low %}<div>Низкий: {{ alarm.ch_low }}</div>{% endif %}
                                        {% if alarm.ch_high %}<div>Высокий: {{ alarm.ch_high }}</div>{% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                {% if alarm.confirm_method %}
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Подтверждение:</strong></div>
                                    <div class="col-8">{{ alarm.get_confirm_method_display }}</div>
                                </div>
                                {% endif %}
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Приоритет:</strong></div>
                                    <div class="col-8">
                                        <span class="badge bg-secondary">{{ alarm.prior }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer text-muted">
                                <small>Создан: {{ alarm.created_at|date:"d.m.Y H:i" }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
            
            <!-- Пагинация -->
            {% if is_paginated %}
            <nav aria-label="Навигация по страницам">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link keep-filters" href="?page=1&display_mode={{ display_mode }}{% for field in sort_fields %}&sort_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for order in sort_orders %}&order_{{ forloop.counter0 }}={{ order }}{% endfor %}{% for field in filter_fields %}&filter_field_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for op in filter_ops %}&filter_op_{{ forloop.counter0 }}={{ op }}{% endfor %}{% for value in filter_values %}&filter_value_{{ forloop.counter0 }}={{ value }}{% endfor %}">&laquo; Первая</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link keep-filters" href="?page={{ page_obj.previous_page_number }}&display_mode={{ display_mode }}{% for field in sort_fields %}&sort_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for order in sort_orders %}&order_{{ forloop.counter0 }}={{ order }}{% endfor %}{% for field in filter_fields %}&filter_field_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for op in filter_ops %}&filter_op_{{ forloop.counter0 }}={{ op }}{% endfor %}{% for value in filter_values %}&filter_value_{{ forloop.counter0 }}={{ value }}{% endfor %}">Предыдущая</a>
                        </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">
                            Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link keep-filters" href="?page={{ page_obj.next_page_number }}&display_mode={{ display_mode }}{% for field in sort_fields %}&sort_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for order in sort_orders %}&order_{{ forloop.counter0 }}={{ order }}{% endfor %}{% for field in filter_fields %}&filter_field_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for op in filter_ops %}&filter_op_{{ forloop.counter0 }}={{ op }}{% endfor %}{% for value in filter_values %}&filter_value_{{ forloop.counter0 }}={{ value }}{% endfor %}">Следующая</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link keep-filters" href="?page={{ page_obj.paginator.num_pages }}&display_mode={{ display_mode }}{% for field in sort_fields %}&sort_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for order in sort_orders %}&order_{{ forloop.counter0 }}={{ order }}{% endfor %}{% for field in filter_fields %}&filter_field_{{ forloop.counter0 }}={{ field }}{% endfor %}{% for op in filter_ops %}&filter_op_{{ forloop.counter0 }}={{ op }}{% endfor %}{% for value in filter_values %}&filter_value_{{ forloop.counter0 }}={{ value }}{% endfor %}">Последняя &raquo;</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        {% else %}
            <div class="text-center text-muted py-5">
                <i class="bi bi-inbox fs-1"></i>
                <h4>Аварийные сигналы не найдены</h4>
                <p>Создайте первый аварийный сигнал для начала работы</p>
                <a href="{% url 'alarms:alarm_create' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Создать первый сигнал
                </a>
            </div>
        {% endif %}
    </div>
</div>

<script>
// === СОРТИРОВКА (фикс багов UI) ===
let sortFieldCounter = 1;

function renderSortFields(savedValues = null) {
    const container = document.getElementById('sortFields');
    container.innerHTML = '';
    let values = savedValues;
    if (!values) {
        // Восстанавливаем из localStorage или из DOM
        const ls = localStorage.getItem('alarmsSortFields');
        if (ls) {
            try { values = JSON.parse(ls); } catch { values = []; }
        } else {
            values = [];
            const currentFields = container.querySelectorAll('.sort-field');
            const currentOrders = container.querySelectorAll('.sort-order');
            for (let i = 0; i < currentFields.length; i++) {
                values.push({
                    field: currentFields[i].value,
                    order: currentOrders[i].value
                });
            }
        }
    }
    // Если нет ни одной строки, добавляем дефолтную
    if (!values || values.length === 0) {
        values = [{field: '', order: 'asc'}];
    }
    for (let i = 0; i < values.length; i++) {
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'col-md-4 mb-2';
        fieldDiv.innerHTML = `
            <select name="sort_${i}" class="form-select form-select-sm sort-field">
                <option value="">Выберите поле</option>
                <option value="id" ${values[i].field === 'id' ? 'selected' : ''}>ID</option>
                <option value="alarm_class" ${values[i].field === 'alarm_class' ? 'selected' : ''}>Класс</option>
                <option value="table" ${values[i].field === 'table' ? 'selected' : ''}>Таблица</option>
                <option value="logic" ${values[i].field === 'logic' ? 'selected' : ''}>Логика</option>
                <option value="channel" ${values[i].field === 'channel' ? 'selected' : ''}>Канал</option>
                <option value="msg" ${values[i].field === 'msg' ? 'selected' : ''}>Сообщение</option>
                <option value="prior" ${values[i].field === 'prior' ? 'selected' : ''}>Приоритет</option>
                <option value="created_at" ${values[i].field === 'created_at' ? 'selected' : ''}>Дата создания</option>
                <option value="updated_at" ${values[i].field === 'updated_at' ? 'selected' : ''}>Дата обновления</option>
            </select>
        `;
        const orderDiv = document.createElement('div');
        orderDiv.className = 'col-md-3 mb-2';
        orderDiv.innerHTML = `
            <select name="order_${i}" class="form-select form-select-sm sort-order">
                <option value="asc" ${values[i].order === 'asc' ? 'selected' : ''}>По возрастанию</option>
                <option value="desc" ${values[i].order === 'desc' ? 'selected' : ''}>По убыванию</option>
            </select>
        `;
        const removeBtn = document.createElement('div');
        removeBtn.className = 'col-md-2 mb-2';
        removeBtn.innerHTML = `
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSortField(${i})">
                <i class="bi bi-trash"></i> Удалить
            </button>
        `;
        const spacer = document.createElement('div');
        spacer.className = 'col-md-2 mb-2';
        container.appendChild(fieldDiv);
        container.appendChild(orderDiv);
        container.appendChild(removeBtn);
        container.appendChild(spacer);
    }
    // Кнопки управления
    const btnGroup = document.createElement('div');
    btnGroup.className = 'd-flex mb-2';

    const clearBtn = document.createElement('div');
    clearBtn.innerHTML = `
        <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="clearSortBtn">
            <i class="bi bi-x"></i> Очистить
        </button>
    `;
    const addBtn = document.createElement('div');
    addBtn.innerHTML = `
        <button type="button" class="btn btn-sm btn-outline-success me-2" id="addSortBtn">
            <i class="bi bi-plus"></i> Добавить
        </button>
    `;
    const applyBtn = document.createElement('div');
    applyBtn.innerHTML = `
        <button type="button" class="btn btn-sm btn-outline-primary" id="applySortBtn">
            <i class="bi bi-check"></i> Применить сортировку
        </button>
    `;
    btnGroup.appendChild(clearBtn);
    btnGroup.appendChild(addBtn);
    btnGroup.appendChild(applyBtn);
    container.appendChild(btnGroup);
    sortFieldCounter = values.length;
    if (document.getElementById('currentSortDisplay')) {
        updateSortDisplay();
    }
}

function addSortField() {
    // Получаем текущие значения
    const container = document.getElementById('sortFields');
    const currentFields = container.querySelectorAll('.sort-field');
    const currentOrders = container.querySelectorAll('.sort-order');
    const savedValues = [];
    for (let i = 0; i < currentFields.length; i++) {
        savedValues.push({
            field: currentFields[i].value,
            order: currentOrders[i].value
        });
    }
    savedValues.push({field: '', order: 'asc'}); // Добавляем только одну новую строку
    renderSortFields(savedValues);
    updateActiveNotices();
}

function removeSortField(index) {
    const container = document.getElementById('sortFields');
    const currentFields = container.querySelectorAll('.sort-field');
    const currentOrders = container.querySelectorAll('.sort-order');
    const savedValues = [];
    for (let i = 0; i < currentFields.length; i++) {
        if (i !== index) {
            savedValues.push({
                field: currentFields[i].value,
                order: currentOrders[i].value
            });
        }
    }
    // Если всё удалили, оставляем одну дефолтную строку
    if (savedValues.length === 0) {
        savedValues.push({field: '', order: 'asc'});
    }
    renderSortFields(savedValues);
    updateActiveNotices();
}

function clearSort() {
    // После очистки всегда одна дефолтная строка
    renderSortFields([{field: '', order: 'asc'}]);
    localStorage.removeItem('alarmsSortFields');
    updateActiveNotices();
}

function updateSortDisplay() {
    const container = document.getElementById('sortFields');
    const currentFields = container.querySelectorAll('.sort-field');
    const currentOrders = container.querySelectorAll('.sort-order');
    const currentSortDisplay = document.getElementById('currentSortDisplay');
    if (!currentSortDisplay) return;
    let displayText = '';
    for (let i = 0; i < currentFields.length; i++) {
        const field = currentFields[i].value;
        const order = currentOrders[i] ? currentOrders[i].value : 'asc';
        if (field) {
            let fieldName = '';
            switch (field) {
                case 'id': fieldName = 'ID'; break;
                case 'alarm_class': fieldName = 'Класс'; break;
                case 'table': fieldName = 'Таблица'; break;
                case 'logic': fieldName = 'Логика'; break;
                case 'channel': fieldName = 'Канал'; break;
                case 'msg': fieldName = 'Сообщение'; break;
                case 'prior': fieldName = 'Приоритет'; break;
                case 'created_at': fieldName = 'Дата создания'; break;
                case 'updated_at': fieldName = 'Дата обновления'; break;
                default: fieldName = field;
            }
            let orderSymbol = order === 'asc' ? '↑' : '↓';
            displayText += `${fieldName} ${orderSymbol}, `;
        }
    }
    currentSortDisplay.textContent = displayText ? displayText.slice(0, -2) : 'Не выбрана';
}

// Восстановление сортировки при загрузке

document.addEventListener('DOMContentLoaded', () => {
    renderSortFields();
    // Кнопка Добавить
    document.addEventListener('click', function(event) {
        if (event.target && event.target.id === 'addSortBtn') {
            event.preventDefault();
            addSortField();
        }
    });
    // Кнопка Очистить
    document.addEventListener('click', function(event) {
        if (event.target && event.target.id === 'clearSortBtn') {
            event.preventDefault();
            clearSort();
        }
    });
    // Кнопка Применить сортировку
    document.addEventListener('click', function(event) {
        if (event.target && event.target.id === 'applySortBtn') {
            event.preventDefault();
            // Собираем параметры сортировки
            const sortFields = document.querySelectorAll('.sort-field');
            const sortOrders = document.querySelectorAll('.sort-order');
            const url = new URL(window.location.href);
            // Удаляем старые sort_ и order_ параметры
            for (const key of Array.from(url.searchParams.keys())) {
                if (key.startsWith('sort_') || key.startsWith('order_')) {
                    url.searchParams.delete(key);
                }
            }
            // Добавляем новые
            let sortCount = 0;
            const sortToSave = [];
            for (let i = 0; i < sortFields.length; i++) {
                const field = sortFields[i].value;
                const order = sortOrders[i] ? sortOrders[i].value : 'asc';
                if (field) {
                    url.searchParams.set(`sort_${sortCount}`, field);
                    url.searchParams.set(`order_${sortCount}`, order);
                    sortToSave.push({field, order});
                    sortCount++;
                }
            }
            // Сохраняем в localStorage
            localStorage.setItem('alarmsSortFields', JSON.stringify(sortToSave));
            // Переходим по новому URL
            window.location.href = url.pathname + '?' + url.searchParams.toString();
        }
    });
});
// === КОНЕЦ СОРТИРОВКИ ===

// Функции для фильтров (оставлены для полноты, но не используются в текущем коде)
function addFilterField(index = null, fieldValue = '', operatorValue = '', valueValue = '') {
    console.log('=== addFilterField вызвана ===');
    console.log('Параметры:', { index, fieldValue, operatorValue, valueValue });
    
    const filterFields = document.getElementById('filterFields');
    console.log('Контейнер filterFields найден:', !!filterFields);
    
    if (!filterFields) {
        console.error('Контейнер filterFields не найден!');
        return;
    }
    
    const currentCount = filterFields.querySelectorAll('.filter-row').length;
    const idx = index !== null ? index : currentCount;
    console.log('Текущее количество фильтров:', currentCount);
    console.log('Индекс для нового фильтра:', idx);
    
    const row = document.createElement('div');
    row.className = 'row mb-2 filter-row';
    row.innerHTML = `
        <div class="col-md-4 mb-1">
            <select name="filter_field_${idx}" class="form-select form-select-sm filter-field" onchange="updateFilterOperators(${idx})">
                <option value="">Выберите поле</option>
                <option value="id" ${fieldValue === 'id' ? 'selected' : ''}>ID</option>
                <option value="alarm_class" ${fieldValue === 'alarm_class' ? 'selected' : ''}>Класс</option>
                <option value="table" ${fieldValue === 'table' ? 'selected' : ''}>Таблица</option>
                <option value="logic" ${fieldValue === 'logic' ? 'selected' : ''}>Логика</option>
                <option value="channel" ${fieldValue === 'channel' ? 'selected' : ''}>Канал</option>
                <option value="msg" ${fieldValue === 'msg' ? 'selected' : ''}>Сообщение</option>
                <option value="prior" ${fieldValue === 'prior' ? 'selected' : ''}>Приоритет</option>
                <option value="created_at" ${fieldValue === 'created_at' ? 'selected' : ''}>Дата создания</option>
                <option value="updated_at" ${fieldValue === 'updated_at' ? 'selected' : ''}>Дата обновления</option>
            </select>
        </div>
        <div class="col-md-3 mb-1">
            <select name="filter_op_${idx}" class="form-select form-select-sm filter-op" onchange="updateFilterValueType(${idx})">
                <option value="exact" ${operatorValue === 'exact' ? 'selected' : ''}>Точно</option>
                <option value="contains" ${operatorValue === 'contains' ? 'selected' : ''}>Содержит</option>
                <option value="startswith" ${operatorValue === 'startswith' ? 'selected' : ''}>Начинается с</option>
                <option value="endswith" ${operatorValue === 'endswith' ? 'selected' : ''}>Заканчивается на</option>
            </select>
        </div>
        <div class="col-md-4 mb-1">
            <input type="text" name="filter_value_${idx}" class="form-control form-control-sm filter-value" value="${valueValue}" placeholder="Значение">
        </div>
        <div class="col-md-1 mb-1 d-flex align-items-center">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.filter-row').remove()" title="Удалить фильтр">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    filterFields.appendChild(row);
    console.log('Фильтр добавлен. Новое количество фильтров:', filterFields.querySelectorAll('.filter-row').length);
    
    // Если поле уже выбрано, обновляем операторы
    if (fieldValue) {
        updateFilterOperators(idx);
        // Если оператор тоже задан, устанавливаем его
        if (operatorValue) {
            const opSelect = row.querySelector('.filter-op');
            if (opSelect) {
                for (let i = 0; i < opSelect.options.length; i++) {
                    if (opSelect.options[i].value === operatorValue) {
                        opSelect.selectedIndex = i;
                        break;
                    }
                }
            }
        }
        
        // Если есть значение, устанавливаем его
        if (valueValue) {
            if (operatorValue === 'range' && (fieldValue === 'created_at' || fieldValue === 'updated_at')) {
                // Для диапазона дат разбираем значение
                const parts = valueValue.split(',');
                if (parts.length === 2) {
                    const startInput = row.querySelector(`input[name="filter_value_${idx}_start"]`);
                    const endInput = row.querySelector(`input[name="filter_value_${idx}_end"]`);
                    if (startInput) startInput.value = parts[0];
                    if (endInput) endInput.value = parts[1];
                }
            } else {
                // Для обычных полей устанавливаем значение
                const valueInput = row.querySelector('.filter-value');
                if (valueInput) valueInput.value = valueValue;
            }
        }
    }
    
    updateActiveNotices();
}

function applyFilters() {
    console.log('=== ПРИМЕНЕНИЕ ФИЛЬТРОВ ===');
    const filterForm = document.getElementById('filterForm');
    
    // Проверяем, что форма существует
    if (!filterForm) {
        console.error('Форма фильтров не найдена!');
        return;
    }
    
    // Строим URL с параметрами фильтрации
    const url = new URL(window.location.href);
    
    console.log('Текущий URL:', window.location.href);
    console.log('Текущий display_mode:', url.searchParams.get('display_mode'));
    
    // Очищаем старые параметры фильтрации
    for (const key of url.searchParams.keys()) {
        if (key.startsWith('filter_')) {
            url.searchParams.delete(key);
            console.log(`Удаляем старый параметр: ${key}`);
        }
    }
    
    // Собираем данные из формы напрямую
    const filterFields = filterForm.querySelectorAll('.filter-field');
    const filterOps = filterForm.querySelectorAll('.filter-op');
    const filterValues = filterForm.querySelectorAll('.filter-value');
    
    console.log('=== ДАННЫЕ ИЗ ФОРМЫ ===');
    console.log('Поля фильтров:', filterFields.length);
    console.log('Операторы фильтров:', filterOps.length);
    console.log('Значения фильтров:', filterValues.length);
    
    // Добавляем новые параметры фильтрации
    let hasFilters = false;
    const filtersData = [];
    
    for (let i = 0; i < filterFields.length; i++) {
        const field = filterFields[i].value;
        const op = filterOps[i] ? filterOps[i].value : 'exact';
        
        // Получаем значение в зависимости от типа оператора
        let value = '';
        if (op === 'range' && (field === 'created_at' || field === 'updated_at')) {
            // Для диапазона дат получаем значения из двух полей
            const startValue = filterForm.querySelector(`input[name="filter_value_${i}_start"]`);
            const endValue = filterForm.querySelector(`input[name="filter_value_${i}_end"]`);
            const start = startValue ? startValue.value : '';
            const end = endValue ? endValue.value : '';
            
            if (start && end) {
                value = `${start},${end}`;
            } else if (start || end) {
                // Если заполнено только одно поле, используем его как точное значение
                value = start || end;
            }
        } else {
            // Для остальных случаев получаем значение из обычного поля
            const valueInput = filterValues[i];
            value = valueInput ? valueInput.value : '';
        }
        
        console.log(`Фильтр ${i}: поле=${field}, оператор=${op}, значение=${value}`);
        
        // Проверяем, что поле и значение заполнены
        if (field && value && value.trim() !== '') {
            url.searchParams.set(`filter_field_${i}`, field);
            url.searchParams.set(`filter_op_${i}`, op);
            url.searchParams.set(`filter_value_${i}`, value.trim());
            hasFilters = true;
            console.log(`Добавляем фильтр ${i}: ${field} ${op} ${value.trim()}`);
            
            // Сохраняем фильтр для localStorage
            filtersData.push({
                field: field,
                op: op,
                value: value.trim()
            });
        } else {
            console.log(`Пропускаем фильтр ${i}: поле=${field}, значение=${value}`);
        }
    }
    
    // Сохраняем фильтры в localStorage
    if (hasFilters) {
        localStorage.setItem('alarms_filters', JSON.stringify(filtersData));
        console.log('Фильтры сохранены в localStorage:', filtersData);
    } else {
        localStorage.removeItem('alarms_filters');
        console.log('Фильтры удалены из localStorage');
    }
    
    // Сохраняем текущий display_mode из URL
    const currentDisplayMode = url.searchParams.get('display_mode');
    if (currentDisplayMode) {
        url.searchParams.set('display_mode', currentDisplayMode);
        console.log(`Сохраняем display_mode: ${currentDisplayMode}`);
    }
    
    console.log('Итоговый URL:', url.toString());
    console.log('Есть ли фильтры:', hasFilters);
    
    if (!hasFilters) {
        console.warn('ВНИМАНИЕ: Ни одного фильтра не найдено в форме!');
        // Не перезагружаем страницу, если нет фильтров
        return;
    }
    
    console.log('Переходим на URL:', url.toString());
    window.location.href = url.toString();
    updateActiveNotices();
}

function clearFilters() {
    console.log('=== ОЧИСТКА ФИЛЬТРОВ ===');
    // Очищаем все фильтры в UI
    const filterFieldsContainer = document.getElementById('filterFields');
    if (filterFieldsContainer) {
        filterFieldsContainer.innerHTML = '';
        addFilterField(); // Добавляем только один дефолтный фильтр
    }
    // Удаляем фильтры из localStorage
    localStorage.removeItem('alarms_filters');
    // Удаляем параметры фильтрации из URL (без перезагрузки)
    const url = new URL(window.location.href);
    for (const key of Array.from(url.searchParams.keys())) {
        if (key.startsWith('filter_')) {
            url.searchParams.delete(key);
        }
    }
    window.history.replaceState({}, '', url.pathname + url.search);
    // Обновляем таблицу аварий (перезагружаем страницу)
    window.location.reload();
    updateActiveNotices();
}



// Функция для восстановления фильтров из URL-параметров или localStorage
function restoreFilters() {
    console.log('=== ВОССТАНОВЛЕНИЕ ФИЛЬТРОВ ===');
    
    // Сначала проверяем localStorage
    const savedFilters = localStorage.getItem('alarms_filters');
    let filtersData = [];
    let shouldApplyFilters = false;
    
    if (savedFilters) {
        try {
            filtersData = JSON.parse(savedFilters);
            console.log('Найдены сохраненные фильтры в localStorage:', filtersData);
            
            // Проверяем, есть ли фильтры в URL
            const urlParams = new URLSearchParams(window.location.search);
            const hasUrlFilters = Array.from(urlParams.keys()).some(key => key.startsWith('filter_'));
            
            // Если в localStorage есть фильтры, но в URL их нет - нужно применить
            if (filtersData.length > 0 && !hasUrlFilters) {
                shouldApplyFilters = true;
                console.log('Фильтры найдены в localStorage, но не в URL - применяем их');
            }
        } catch (e) {
            console.error('Ошибка при парсинге фильтров из localStorage:', e);
            localStorage.removeItem('alarms_filters');
        }
    }
    
    // Если в localStorage нет фильтров, проверяем URL (но только если мы не в процессе очистки)
    const isClearing = sessionStorage.getItem('clearing_filters');
    if (filtersData.length === 0 && !isClearing) {
        const urlParams = new URLSearchParams(window.location.search);
        const filterFields = [];
        const filterOps = [];
        const filterValues = [];
        
        console.log('URL параметры:', window.location.search);
        
        // Собираем все параметры фильтров из URL
        for (const [key, value] of urlParams.entries()) {
            console.log(`Параметр: ${key} = ${value}`);
            if (key.startsWith('filter_field_')) {
                const index = key.replace('filter_field_', '');
                filterFields[index] = value;
            } else if (key.startsWith('filter_op_')) {
                const index = key.replace('filter_op_', '');
                filterOps[index] = value;
            } else if (key.startsWith('filter_value_')) {
                const index = key.replace('filter_value_', '');
                filterValues[index] = value;
            }
        }
        
        console.log('Найденные фильтры в URL:', { filterFields, filterOps, filterValues });
        
        // Преобразуем данные из URL в формат для восстановления
        const maxIndex = Math.max(filterFields.length, filterOps.length, filterValues.length);
        for (let i = 0; i < maxIndex; i++) {
            const field = filterFields[i] || '';
            const op = filterOps[i] || '';
            const value = filterValues[i] || '';
            
            if (field || op || value) {
                filtersData.push({
                    field: field,
                    op: op,
                    value: value
                });
            }
        }
        
        // Если найдены фильтры в URL, сохраняем их в localStorage
        if (filtersData.length > 0) {
            localStorage.setItem('alarms_filters', JSON.stringify(filtersData));
            console.log('Фильтры из URL сохранены в localStorage');
        }
    }
    
    console.log('Итоговые данные фильтров для восстановления:', filtersData);
    
    // Очищаем существующие фильтры
    const filterFieldsContainer = document.getElementById('filterFields');
    if (!filterFieldsContainer) {
        console.error('Контейнер фильтров не найден!');
        return;
    }
    filterFieldsContainer.innerHTML = '';
    
    // Восстанавливаем фильтры
    for (let i = 0; i < filtersData.length; i++) {
        const filter = filtersData[i];
        console.log(`Восстанавливаем фильтр ${i}:`, filter);
        addFilterField(i, filter.field, filter.op, filter.value);
    }
    
    // Если есть активные фильтры, открываем спойлер
    if (filtersData.length > 0) {
        const filterSettingsBody = document.getElementById('filterSettingsBody');
        const filterToggleIcon = document.getElementById('filterToggleIcon');
        if (filterSettingsBody && filterToggleIcon) {
            filterSettingsBody.style.display = 'block';
            filterToggleIcon.className = 'bi bi-chevron-down';
            console.log('Спойлер фильтров открыт');
        }
    }
    
    // Если нет фильтров, добавляем пустой
    if (filtersData.length === 0) {
        console.log('Добавляем пустой фильтр');
        addFilterField();
    }
    
    // Проверяем кнопку после восстановления фильтров
    setTimeout(() => {
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        console.log('Проверка кнопки clearFiltersBtn через 1 секунду:', !!clearFiltersBtn);
        if (clearFiltersBtn) {
            console.log('Кнопка найдена, добавляем обработчик');
            clearFiltersBtn.onclick = function(event) {
                event.preventDefault();
                event.stopPropagation();
                console.log('Кнопка "Очистить все фильтры" нажата (onclick)');
                clearFilters();
                return false;
            };
            
            // Добавляем обработчик mousedown с очень высоким приоритетом
            clearFiltersBtn.addEventListener('mousedown', function(event) {
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();
                console.log('Кнопка "Очистить все фильтры" нажата (mousedown)');
                clearFilters();
                return false;
            }, true);
            
            // Добавляем обработчик mouseup
            clearFiltersBtn.addEventListener('mouseup', function(event) {
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();
                console.log('Кнопка "Очистить все фильтры" отпущена (mouseup)');
                return false;
            }, true);
            
            // Добавляем обработчик click
            clearFiltersBtn.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();
                console.log('Кнопка "Очистить все фильтры" нажата (addEventListener click)');
                clearFilters();
                return false;
            }, true);
        } else {
            console.log('Кнопка clearFiltersBtn не найдена через 1 секунду');
        }
    }, 1000);
    
    // Если нужно применить фильтры из localStorage, делаем это
    if (shouldApplyFilters && filtersData.length > 0) {
        console.log('Автоматически применяем фильтры из localStorage');
        setTimeout(() => {
            applyFilters();
        }, 100); // Небольшая задержка для завершения восстановления UI
    }
    updateActiveNotices();
}

// Функции для сортировки
function toggleSortSettings() {
    const sortSettingsBody = document.getElementById('sortSettingsBody');
    const sortToggleIcon = document.getElementById('sortToggleIcon');
    if (!sortSettingsBody || !sortToggleIcon) return;
    if (sortSettingsBody.style.display === 'none' || sortSettingsBody.style.display === '') {
        sortSettingsBody.style.display = 'block';
        sortToggleIcon.className = 'bi bi-chevron-down';
        localStorage.setItem('alarmsSortSettingsExpanded', 'true');
    } else {
        sortSettingsBody.style.display = 'none';
        sortToggleIcon.className = 'bi bi-chevron-right';
        localStorage.setItem('alarmsSortSettingsExpanded', 'false');
    }
    const sortActiveNotice = document.getElementById('sortActiveNotice');
    if (sortSettingsBody.style.display === 'none' || sortSettingsBody.style.display === '') {
        if (sortActiveNotice) sortActiveNotice.style.display = 'none';
    } else {
        // Проверяем, есть ли активная сортировка
        let active = false;
        document.querySelectorAll('.sort-field').forEach(f => { if (f.value) active = true; });
        if (sortActiveNotice) sortActiveNotice.style.display = active ? 'block' : 'none';
    }
    updateActiveNotices();
}

function toggleFilterSettings() {
    const filterSettingsBody = document.getElementById('filterSettingsBody');
    const filterToggleIcon = document.getElementById('filterToggleIcon');
    if (!filterSettingsBody || !filterToggleIcon) return;
    if (filterSettingsBody.style.display === 'none' || filterSettingsBody.style.display === '') {
        filterSettingsBody.style.display = 'block';
        filterToggleIcon.className = 'bi bi-chevron-down';
        localStorage.setItem('alarmsFilterSettingsExpanded', 'true');
    } else {
        filterSettingsBody.style.display = 'none';
        filterToggleIcon.className = 'bi bi-chevron-right';
        localStorage.setItem('alarmsFilterSettingsExpanded', 'false');
    }
    const filtersActiveNotice = document.getElementById('filtersActiveNotice');
    if (filterSettingsBody.style.display === 'none' || filterSettingsBody.style.display === '') {
        if (filtersActiveNotice) filtersActiveNotice.style.display = 'none';
    } else {
        // Проверяем, есть ли активные фильтры
        let active = false;
        document.querySelectorAll('.filter-row').forEach(row => {
            const field = row.querySelector('.filter-field');
            const op = row.querySelector('.filter-op');
            const val = row.querySelector('.filter-value');
            if (field && field.value && op && op.value && val && val.value) active = true;
        });
        if (filtersActiveNotice) filtersActiveNotice.style.display = active ? 'block' : 'none';
    }
    updateActiveNotices();
}

// Функция для обновления страницы при изменении параметров сортировки или фильтров
function updatePage() {
    const currentUrl = new URL(window.location.href);
    const displayMode = currentUrl.searchParams.get('display_mode');
    const sortFields = Array.from(currentUrl.searchParams.keys()).filter(key => key.startsWith('sort_'));
    const sortOrders = Array.from(currentUrl.searchParams.keys()).filter(key => key.startsWith('order_'));
    const filterFields = Array.from(currentUrl.searchParams.keys()).filter(key => key.startsWith('filter_'));

    let url = `?display_mode=${displayMode}`;
    sortFields.forEach(field => {
        const index = field.replace('sort_', '');
        const value = currentUrl.searchParams.get(field);
        url += `&${field}=${value}`;
    });
    sortOrders.forEach(order => {
        const index = order.replace('order_', '');
        const value = currentUrl.searchParams.get(order);
        url += `&${order}=${value}`;
    });
    filterFields.forEach(field => {
        const index = field.replace('filter_field_', '');
        const value = currentUrl.searchParams.get(field);
        url += `&${field}=${value}`;
    });

    window.location.href = url;
}

function updateActiveNotices() {
    // Сортировка
    const sortActiveNotice = document.getElementById('sortActiveNotice');
    let sortActive = false;
    document.querySelectorAll('.sort-field').forEach(f => { if (f.value) sortActive = true; });
    if (sortActiveNotice) {
        sortActiveNotice.style.display = sortActive ? 'inline-block' : 'none';
    }
    // Фильтры
    const filtersActiveNotice = document.getElementById('filtersActiveNotice');
    let filtersActive = false;
    document.querySelectorAll('.filter-row').forEach(row => {
        const field = row.querySelector('.filter-field');
        const op = row.querySelector('.filter-op');
        const val = row.querySelector('.filter-value');
        if (field && field.value && op && op.value && val && val.value) filtersActive = true;
    });
    if (filtersActiveNotice) {
        filtersActiveNotice.style.display = filtersActive ? 'inline-block' : 'none';
    }
}

// Функция для обновления операторов фильтра в зависимости от выбранного поля
function updateFilterOperators(idx) {
    const filterRow = document.querySelectorAll('.filter-row')[idx];
    if (!filterRow) return;
    
    const fieldSelect = filterRow.querySelector('.filter-field');
    const opSelect = filterRow.querySelector('.filter-op');
    const valueInput = filterRow.querySelector('.filter-value');
    
    if (!fieldSelect || !opSelect || !valueInput) return;
    
    const selectedField = fieldSelect.value;
    
    // Очищаем текущие операторы
    opSelect.innerHTML = '';
    
    // Определяем операторы в зависимости от типа поля
    if (selectedField === 'created_at' || selectedField === 'updated_at') {
        // Для дат используем операторы сравнения
        const dateOperators = [
            {value: 'exact', text: 'Равно'},
            {value: 'gt', text: 'Больше'},
            {value: 'lt', text: 'Меньше'},
            {value: 'gte', text: 'Больше или равно'},
            {value: 'lte', text: 'Меньше или равно'},
            {value: 'range', text: 'Диапазон'}
        ];
        
        dateOperators.forEach(op => {
            const option = document.createElement('option');
            option.value = op.value;
            option.textContent = op.text;
            opSelect.appendChild(option);
        });
        
        // Устанавливаем тип поля ввода как date
        valueInput.type = 'date';
        valueInput.placeholder = 'ГГГГ-ММ-ДД';
        
    } else if (selectedField === 'prior') {
        // Для приоритета используем числовые операторы
        const numericOperators = [
            {value: 'exact', text: 'Равно'},
            {value: 'gt', text: 'Больше'},
            {value: 'lt', text: 'Меньше'},
            {value: 'gte', text: 'Больше или равно'},
            {value: 'lte', text: 'Меньше или равно'},
            {value: 'contains', text: 'Содержит'},
            {value: 'startswith', text: 'Начинается с'},
            {value: 'endswith', text: 'Заканчивается на'}
        ];
        
        numericOperators.forEach(op => {
            const option = document.createElement('option');
            option.value = op.value;
            option.textContent = op.text;
            opSelect.appendChild(option);
        });
        
        // Устанавливаем тип поля ввода как number
        valueInput.type = 'number';
        valueInput.placeholder = 'Число';
        
    } else {
        // Для остальных полей используем строковые операторы
        const stringOperators = [
            {value: 'exact', text: 'Точно'},
            {value: 'contains', text: 'Содержит'},
            {value: 'startswith', text: 'Начинается с'},
            {value: 'endswith', text: 'Заканчивается на'}
        ];
        
        stringOperators.forEach(op => {
            const option = document.createElement('option');
            option.value = op.value;
            option.textContent = op.text;
            opSelect.appendChild(option);
        });
        
        // Устанавливаем тип поля ввода как text
        valueInput.type = 'text';
        valueInput.placeholder = 'Значение';
    }
    
    // Устанавливаем первый оператор по умолчанию
    if (opSelect.options.length > 0) {
        opSelect.selectedIndex = 0;
    }
}

// Функция для обновления типа поля ввода при изменении оператора
function updateFilterValueType(idx) {
    const filterRow = document.querySelectorAll('.filter-row')[idx];
    if (!filterRow) return;
    
    const fieldSelect = filterRow.querySelector('.filter-field');
    const opSelect = filterRow.querySelector('.filter-op');
    const valueInput = filterRow.querySelector('.filter-value');
    
    if (!fieldSelect || !opSelect || !valueInput) return;
    
    const selectedField = fieldSelect.value;
    const selectedOp = opSelect.value;
    
    if (selectedField === 'created_at' || selectedField === 'updated_at') {
        if (selectedOp === 'range') {
            // Для диапазона дат создаем специальный виджет
            const valueContainer = valueInput.parentElement;
            valueContainer.innerHTML = `
                <div class="row g-1">
                    <div class="col-6">
                        <input type="date" name="filter_value_${idx}_start" class="form-control form-control-sm filter-value-start" placeholder="От">
                    </div>
                    <div class="col-6">
                        <input type="date" name="filter_value_${idx}_end" class="form-control form-control-sm filter-value-end" placeholder="До">
                    </div>
                </div>
            `;
        } else {
            // Для остальных операторов дат используем обычное поле даты
            const valueContainer = valueInput.parentElement;
            valueContainer.innerHTML = `
                <input type="date" name="filter_value_${idx}" class="form-control form-control-sm filter-value" placeholder="ГГГГ-ММ-ДД">
            `;
        }
    } else if (selectedField === 'prior') {
        if (['gt', 'lt', 'gte', 'lte', 'exact'].includes(selectedOp)) {
            valueInput.type = 'number';
            valueInput.placeholder = 'Число';
        } else {
            valueInput.type = 'text';
            valueInput.placeholder = 'Значение';
        }
    } else {
        valueInput.type = 'text';
        valueInput.placeholder = 'Значение';
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    // --- Автоматическое применение сортировки при входе ---
    const url = new URL(window.location.href);
    let hasSortParams = false;
    for (const key of url.searchParams.keys()) {
        if (key.startsWith('sort_')) {
            hasSortParams = true;
            break;
        }
    }
    if (!hasSortParams) {
        const savedSort = localStorage.getItem('alarmsSortFields');
        if (savedSort) {
            try {
                const sortArr = JSON.parse(savedSort);
                if (Array.isArray(sortArr) && sortArr.length > 0 && sortArr.some(s => s.field)) {
                    // Добавляем параметры сортировки в URL
                    sortArr.forEach((s, i) => {
                        if (s.field) {
                            url.searchParams.set(`sort_${i}`, s.field);
                            url.searchParams.set(`order_${i}`, s.order || 'asc');
                        }
                    });
                    window.location.replace(url.pathname + '?' + url.searchParams.toString());
                    return;
                }
            } catch (e) {}
        }
    }
    // Очищаем флаг очистки фильтров, если он был установлен
    sessionStorage.removeItem('clearing_filters');
    
    // Инициализация сортировки
    renderSortFields(); // Добавляем хотя бы одно поле сортировки по умолчанию
    updateSortDisplay();

    // Восстанавливаем фильтры из URL-параметров
    restoreFilters();

    // Восстановление состояния спойлеров
    const sortSettingsBody = document.getElementById('sortSettingsBody');
    const sortToggleIcon = document.getElementById('sortToggleIcon');
    if (localStorage.getItem('alarmsSortSettingsExpanded') === 'false') {
        if (sortSettingsBody && sortToggleIcon) {
            sortSettingsBody.style.display = 'none';
            sortToggleIcon.className = 'bi bi-chevron-right';
        }
    } else {
        if (sortSettingsBody && sortToggleIcon) {
            sortSettingsBody.style.display = 'block';
            sortToggleIcon.className = 'bi bi-chevron-down';
        }
    }
    const filterSettingsBody = document.getElementById('filterSettingsBody');
    const filterToggleIcon = document.getElementById('filterToggleIcon');
    if (localStorage.getItem('alarmsFilterSettingsExpanded') === 'false') {
        if (filterSettingsBody && filterToggleIcon) {
            filterSettingsBody.style.display = 'none';
            filterToggleIcon.className = 'bi bi-chevron-right';
        }
    } else {
        if (filterSettingsBody && filterToggleIcon) {
            filterSettingsBody.style.display = 'block';
            filterToggleIcon.className = 'bi bi-chevron-down';
        }
    }

    // Добавляем параметры фильтрации ко всем ссылкам с классом .keep-filters (делегирование событий)
    document.addEventListener('click', function(event) {
        if (event.target.closest('a.keep-filters')) {
            event.preventDefault();
            const link = event.target.closest('a.keep-filters');
            const url = new URL(link.href, window.location.origin);
            const currentParams = new URLSearchParams(window.location.search);
            
            console.log('=== ОБРАБОТКА ССЫЛКИ KEEP-FILTERS ===');
            console.log('Исходная ссылка:', link.href);
            console.log('Текущие параметры URL:', window.location.search);
            
            // Копируем все filter_ параметры
            let filterCount = 0;
            for (const [key, value] of currentParams.entries()) {
                if (key.startsWith('filter_')) {
                    url.searchParams.set(key, value);
                    filterCount++;
                    console.log(`Добавляем параметр: ${key} = ${value}`);
                }
            }
            // Также копируем display_mode, если есть
            if (currentParams.has('display_mode')) {
                url.searchParams.set('display_mode', currentParams.get('display_mode'));
                console.log(`Добавляем display_mode: ${currentParams.get('display_mode')}`);
            }
            
            console.log(`Найдено фильтров: ${filterCount}`);
            console.log('Итоговый URL:', url.toString());
            
            // Проверяем, что URL действительно изменился
            if (url.toString() !== link.href) {
                console.log('URL изменен, переходим...');
                window.location.href = url.toString();
            } else {
                console.log('URL не изменился, используем исходную ссылку');
                window.location.href = link.href;
            }
        }
    });

    // Добавляем обработчик Enter для полей фильтра
    document.addEventListener('keypress', function(event) {
        if (event.target.classList.contains('filter-value') && event.key === 'Enter') {
            event.preventDefault();
            console.log('Enter нажат в поле фильтра, применяем фильтры...');
            applyFilters();
        }
    });

    // Добавляем обработчик для кнопки "Применить фильтры"
    const applyFiltersBtn = document.getElementById('applyFiltersBtn');
    if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', function() {
            console.log('Кнопка "Применить фильтры" нажата');
            applyFilters();
        });
    }

    // Добавляем обработчик для кнопки "Очистить все фильтры" через делегирование событий
    document.addEventListener('click', function(event) {
        if (event.target.closest('#clearFiltersBtn')) {
            event.preventDefault();
            event.stopPropagation();
            console.log('Кнопка "Очистить все фильтры" нажата (через делегирование)');
            clearFilters();
            return false;
        }
    });

    // Добавляем обработчик для кнопки "Применить сортировку"
    document.addEventListener('click', function(event) {
        if (event.target && event.target.id === 'applySortBtn') {
            event.preventDefault();
            // Собираем параметры сортировки
            const sortFields = document.querySelectorAll('.sort-field');
            const sortOrders = document.querySelectorAll('.sort-order');
            const url = new URL(window.location.href);
            // Удаляем старые sort_ и order_ параметры
            for (const key of Array.from(url.searchParams.keys())) {
                if (key.startsWith('sort_') || key.startsWith('order_')) {
                    url.searchParams.delete(key);
                }
            }
            // Добавляем новые
            let sortCount = 0;
            const sortToSave = [];
            for (let i = 0; i < sortFields.length; i++) {
                const field = sortFields[i].value;
                const order = sortOrders[i] ? sortOrders[i].value : 'asc';
                if (field) {
                    url.searchParams.set(`sort_${sortCount}`, field);
                    url.searchParams.set(`order_${sortCount}`, order);
                    sortToSave.push({field, order});
                    sortCount++;
                }
            }
            // Сохраняем в localStorage
            localStorage.setItem('alarmsSortFields', JSON.stringify(sortToSave));
            // Переходим по новому URL
            window.location.href = url.pathname + '?' + url.searchParams.toString();
        }
    });
    updateActiveNotices();
});
</script>
{% endblock %}
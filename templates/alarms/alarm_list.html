{% extends 'base.html' %}
{% load static %}

{% block title %}{% include 'alarms/includes/page_title.html' with page_title="Тревоги" %}{% endblock %}

{% block extra_css %}
<!-- AG Grid CSS -->
<link rel="stylesheet" href="{% static 'libs/ag-grid/css/ag-grid.css' %}">
<link rel="stylesheet" href="{% static 'libs/ag-grid/css/ag-theme-alpine.css' %}">

<style>
    /* Переопределяем ограничения контейнеров для лучшей адаптивности */
    .container-fluid {
        max-width: none !important;
        padding-left: 15px !important;
        padding-right: 15px !important;
        height: 100vh; /* Полная высота экрана */
        display: flex;
        flex-direction: column;
    }
    
    /* Основной контент занимает все доступное пространство */
    .container-fluid > div:last-child {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    /* Адаптивный контейнер для AG Grid */
    #alarmsGrid {
        width: 100% !important;
        min-width: 0; /* Позволяет контейнеру сжиматься */
        overflow: auto; /* Разрешаем скролл для resize */
        min-height: 400px; /* Минимальная высота */
    }
    
    /* Responsive стили для мобильных устройств */
    @media (max-width: 768px) {
        #alarmsGrid {
            min-height: 350px;
        }
        
        .btn-toolbar {
            flex-direction: column;
            gap: 10px;
        }
        
        .btn-toolbar .btn-group {

        }
        
        .btn-toolbar .btn {

        }
        
        /* Уменьшаем отступы на планшетах */
        .container-fluid {
            padding-left: 10px !important;
            padding-right: 10px !important;
        }
    }
    
    @media (max-width: 576px) {
        #alarmsGrid {
            min-height: 300px;
        }
        
        .d-flex.justify-content-between {
            flex-direction: column;
            gap: 15px;
        }
        
        .h2 {
            font-size: 1.5rem;
        }
        
        /* Уменьшаем отступы на мобильных */
        .container-fluid {
            padding-left: 5px !important;
            padding-right: 5px !important;
        }
    }
    
    /* Стили для кнопок действий */
    .action-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }
    
    .action-buttons .btn {
        padding: 2px 6px;
        font-size: 12px;
    }
    
    /* Responsive кнопки действий */
    @media (max-width: 576px) {
        .action-buttons {
            flex-direction: column;
            gap: 2px;
        }
        
        .action-buttons .btn {
            text-align: center;
        }
        
        /* Responsive заголовки на мобильных */
        .h2 {
            font-size: 1.5rem;
        }
        
        /* Вертикальное выравнивание заголовков и кнопок */
        .d-flex.align-items-center .h2 {
            line-height: 1.2;
            margin-bottom: 0;
        }
        
        .d-flex.align-items-center .btn-toolbar {
            margin-bottom: 0;
        }
        
        /* Стили для хинтов (tooltips) */
        .ag-cell[title] {
            cursor: help;
        }
        
        .description-cell[data-tooltip] {
            cursor: help;
            position: relative;
        }
        
        /* Кастомные стили для хинтов */
        .ag-cell[title]:hover::after {
            content: attr(title);
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 300px;
            white-space: pre-wrap;
            word-wrap: break-word;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        /* Стили для хинтов в ячейках описания */
        .description-cell[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 300px;
            white-space: pre-wrap;
            word-wrap: break-word;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            top: 100%;
            left: 0;
            margin-top: 5px;
        }
    }
    
    /* Стили для приоритетов */
    .priority-high {
        color: #dc3545;
        font-weight: bold;
    }
    

    
    /* Стили для ячеек с длинным контентом */
    .description-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }
    
    /* Убираем отступы у сообщений */
    .alert {
        margin-bottom: 0.5rem;
    }
    
    /* Убираем отступы у первого элемента в контейнере */
    .container-fluid > *:first-child {
        margin-top: 0;
        padding-top: 0;
    }
    
    /* Убираем отступы у всех элементов в main-content */
    .main-content > *:first-child {
        margin-top: 0;
        padding-top: 0;
    }
    
    /* Стили для AG Grid ячеек */
    .ag-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .priority-medium {
        color: #fd7e14;
        font-weight: bold;
    }
    
    .priority-low {
        color: #28a745;
        font-weight: bold;
    }
    
    /* Стили для классов тревог */
    .alarm-class-critical {
        background-color: #dc3545;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
    }
    
    .alarm-class-warning {
        background-color: #fd7e14;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
    }
    
    .alarm-class-info {
        background-color: #17a2b8;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
    }
    
    /* Responsive классы тревог */
    @media (max-width: 576px) {
        .alarm-class-critical,
        .alarm-class-warning,
        .alarm-class-info {
            font-size: 10px;
            padding: 1px 4px;
        }
    }
    
    /* Стили для описания */
    .description-cell {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* Responsive описание */
    @media (max-width: 768px) {
        .description-cell {
            max-width: 200px;
        }
    }
    
    @media (max-width: 576px) {
        .description-cell {
            max-width: 150px;
        }
    }
    
    /* Стили для дат */
    .date-cell {
        font-size: 12px;
        color: #666;
    }
    
    /* Responsive даты */
    @media (max-width: 576px) {
        .date-cell {
            font-size: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-2 border-bottom" style="min-height: 80px;">
    <h1 class="h2 mb-0 d-flex align-items-center">
        <i class="bi bi-exclamation-triangle me-2"></i>Тревоги
    </h1>
    <div class="btn-toolbar mb-0 d-flex align-items-center">
        <div class="btn-group me-2">
            <a href="{% url 'alarms:alarm_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Добавить тревогу
            </a>
        </div>
    </div>
</div>

<!-- Контейнер для AG Grid -->
<div id="alarmsGrid" class="ag-theme-alpine" style="flex: 1;"></div>

<!-- AG Grid JavaScript -->
<script src="{% static 'libs/ag-grid/js/ag-grid-community.min.js' %}"></script>
<!-- Русская локализация AG Grid -->
<script src="{% static 'js/ag-grid-russian-locale.js' %}"></script>

<script>
// Данные для AG Grid
const alarmData = {{ alarm_data|safe }};



// Функция для расчета оптимальной ширины столбца на основе данных
function calculateColumnWidth(field, data, minWidth = 50, maxWidth = 300) {
    if (!data || data.length === 0) return minWidth;
    
    let maxLength = 0;
    data.forEach(row => {
        if (row[field]) {
            const length = String(row[field]).length;
            maxLength = Math.max(maxLength, length);
        }
    });
    
    // Примерная ширина: 8px на символ + отступы
    const calculatedWidth = Math.max(minWidth, Math.min(maxWidth, maxLength * 8 + 20));
    return calculatedWidth;
}

// Функция для определения конфигурации столбцов в зависимости от размера экрана
function getColumnDefs() {
    const isMobile = window.innerWidth <= 576;
    const isTablet = window.innerWidth <= 768;
    
    return [
        { 
            headerName: 'ID', 
            field: 'id', 
            width: calculateColumnWidth('id', alarmData, 50, 80),
            sortable: true, 
            filter: true,
            pinned: 'left',
            hide: isMobile, // Скрываем ID на мобильных
            suppressSizeToFit: false
        },
        { 
            headerName: 'Канал', 
            field: 'channel', 
            width: calculateColumnWidth('channel', alarmData, 80, 200),
            sortable: true, 
            filter: true,
            cellRenderer: function(params) {
                const value = params.value;
                return value ? `<code>${value}</code>` : '<em class="text-muted">Не указан</em>';
            }
        },
        { 
            headerName: 'Сообщение', 
            field: 'message', 
            width: calculateColumnWidth('message', alarmData, 120, 300),
            sortable: true, 
            filter: true,
            cellRenderer: function(params) {
                const value = params.value;
                if (value) {
                    const shortValue = value.length > 50 ? value.substring(0, 50) + '...' : value;
                    return `<div class="description-cell" data-tooltip="${value}">${shortValue}</div>`;
                }
                return '<em class="text-muted">Не указано</em>';
            }
        },
        { 
            headerName: 'Таблица', 
            field: 'table', 

            sortable: true, 
            filter: true,
            hide: isMobile, // Скрываем таблицу на мобильных

            cellRenderer: function(params) {
                const value = params.value;
                return value ? `<span class="badge bg-info">${value}</span>` : '<em class="text-muted">Не указана</em>';
            }
        },
        { 
            headerName: 'Класс тревоги', 
            field: 'alarm_class', 

            sortable: true, 
            filter: true,

            cellRenderer: function(params) {
                const value = params.value;
                if (!value) return '<em class="text-muted">Не указан</em>';
                
                let badgeClass = 'alarm-class-info';
                if (value === 'Критическая' || value === 'Авария') {
                    badgeClass = 'alarm-class-critical';
                } else if (value === 'Важная' || value === 'Предупреждение') {
                    badgeClass = 'alarm-class-warning';
                }
                
                return `<span class="${badgeClass}">${value}</span>`;
            }
        },
        { 
            headerName: 'Способ наблюдения', 
            field: 'logic', 

            sortable: true, 
            filter: true,
            hide: isMobile, // Скрываем способ наблюдения на мобильных

        },
        { 
            headerName: 'Способ подтверждения', 
            field: 'confirm_method', 

            sortable: true, 
            filter: true,
            hide: isMobile, // Скрываем способ подтверждения на мобильных

        },
        { 
            headerName: 'Приоритет', 
            field: 'priority', 

            sortable: true, 
            filter: true,

            cellRenderer: function(params) {
                const priority = params.value;
                let color = 'black';
                if (priority >= 800) color = 'red';
                else if (priority >= 500) color = 'orange';
                else if (priority >= 300) color = 'blue';
                return `<span style="color: ${color}; font-weight: bold;">${priority}</span>`;
            }
        },
        { 
            headerName: 'Тип ограничения', 
            field: 'limit_type', 

            sortable: true, 
            filter: true,
            hide: isMobile, // Скрываем тип ограничения на мобильных

        },
        { 
            headerName: 'Тип настройки пределов', 
            field: 'limit_config_type', 

            sortable: true, 
            filter: true,
            hide: isMobile, // Скрываем тип настройки пределов на мобильных

        },
        { 
            headerName: 'Нижний предел', 
            field: 'low_limit', 

            sortable: true, 
            filter: true,
            hide: isMobile, // Скрываем нижний предел на мобильных

            cellRenderer: function(params) {
                const value = params.value;
                return value !== null && value !== undefined ? value : '<em class="text-muted">-</em>';
            }
        },
        { 
            headerName: 'Верхний предел', 
            field: 'high_limit', 

            sortable: true, 
            filter: true,
            hide: isMobile, // Скрываем верхний предел на мобильных

            cellRenderer: function(params) {
                const value = params.value;
                return value !== null && value !== undefined ? value : '<em class="text-muted">-</em>';
            }
        },
        { 
            headerName: 'Канал нижнего предела', 
            field: 'ch_low', 

            sortable: true, 
            filter: true,
            hide: isMobile, // Скрываем канал нижнего предела на мобильных

            cellRenderer: function(params) {
                const value = params.value;
                return value ? `<code>${value}</code>` : '<em class="text-muted">-</em>';
            }
        },
        { 
            headerName: 'Канал верхнего предела', 
            field: 'ch_high', 

            sortable: true, 
            filter: true,
            hide: isMobile, // Скрываем канал верхнего предела на мобильных

            cellRenderer: function(params) {
                const value = params.value;
                return value ? `<code>${value}</code>` : '<em class="text-muted">-</em>';
            }
        },
        { 
            headerName: 'Гистерезис нижний', 
            field: 'hyst_low', 

            sortable: true, 
            filter: true,
            hide: isMobile, // Скрываем гистерезис нижний на мобильных

            cellRenderer: function(params) {
                const value = params.value;
                return value !== null && value !== undefined ? value : '<em class="text-muted">-</em>';
            }
        },
        { 
            headerName: 'Гистерезис верхний', 
            field: 'hyst_high', 

            sortable: true, 
            filter: true,
            hide: isMobile, // Скрываем гистерезис верхний на мобильных

            cellRenderer: function(params) {
                const value = params.value;
                return value !== null && value !== undefined ? value : '<em class="text-muted">-</em>';
            }
        },
        { 
            headerName: 'Дискретное значение', 
            field: 'discrete_val', 

            sortable: true, 
            filter: true,
            hide: isMobile, // Скрываем дискретное значение на мобильных

            cellRenderer: function(params) {
                const value = params.value;
                return value !== null && value !== undefined ? value : '<em class="text-muted">-</em>';
            }
        },
        { 
            headerName: 'Дата создания', 
            field: 'created_at', 

            sortable: true, 
            filter: true,
            hide: isMobile, // Скрываем дату создания на мобильных

            cellRenderer: function(params) {
                return `<div class="date-cell">${params.value}</div>`;
            }
        },
        { 
            headerName: 'Дата обновления', 
            field: 'updated_at', 

            sortable: true, 
            filter: true,
            hide: isMobile, // Скрываем дату обновления только на мобильных

            cellRenderer: function(params) {
                return `<div class="date-cell">${params.value}</div>`;
            }
        },
        {
            headerName: 'Действия',
            field: 'actions',

            sortable: false,
            filter: false,

            cellRenderer: function(params) {
                const alarmId = params.data.id;
                return `
                    <div class="action-buttons">
                        <a href="/alarms/${alarmId}/edit/" class="btn btn-sm btn-outline-primary me-1" title="Редактировать">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <a href="/alarms/${alarmId}/delete/" class="btn btn-sm btn-outline-danger" title="Удалить">
                            <i class="bi bi-trash"></i>
                        </a>
                    </div>
                `;
            }
        }
    ];
}

// Функция для создания кастомных хинтов
function createCustomTooltips() {
    const tooltipElements = document.querySelectorAll('[data-tooltip]');
    tooltipElements.forEach(element => {
        element.addEventListener('mouseenter', function(e) {
            const tooltipText = this.getAttribute('data-tooltip');
            if (!tooltipText) return;
            
            const tooltip = document.createElement('div');
            tooltip.className = 'custom-tooltip';
            tooltip.textContent = tooltipText;
            tooltip.style.cssText = `
                position: absolute;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 12px;
                max-width: 300px;
                white-space: pre-wrap;
                word-wrap: break-word;
                z-index: 1000;
                pointer-events: none;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                top: ${e.pageY + 10}px;
                left: ${e.pageX + 10}px;
            `;
            
            document.body.appendChild(tooltip);
            this._tooltip = tooltip;
        });
        
        element.addEventListener('mouseleave', function() {
            if (this._tooltip) {
                this._tooltip.remove();
                this._tooltip = null;
            }
        });
    });
}

// Конфигурация AG Grid
const gridOptions = {
    theme: 'legacy',
    columnDefs: getColumnDefs(),
    rowData: alarmData,
    domLayout: 'normal', // Нормальный режим для адаптивной высоты под экран
    suppressColumnVirtualisation: false,
    suppressRowVirtualisation: false,
    defaultColDef: { 
        sortable: true, 
        filter: true, 
        resizable: true,
        minWidth: 50,
        maxWidth: 300, // Максимальная ширина столбцов
        suppressSizeToFit: false,
        autoHeight: true
    },
    pagination: true,
    paginationPageSize: 20,
    paginationPageSizeSelector: [10, 20, 50, 100],
    multiSortKey: 'ctrl',
    rowSelection: 'multiRow',
    animateRows: true,
    // Применяем русскую локализацию
    localeText: agGridRussianLocale,
        onGridReady: function(params) {
        // Добавляем кнопки экспорта
        const header = document.querySelector('.btn-toolbar');
        if (header && !document.querySelector('.export-buttons')) {
            const exportGroup = document.createElement('div');
            exportGroup.className = 'btn-group me-2 export-buttons';
            exportGroup.innerHTML = `
                <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-download"></i> Экспорт
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="exportToExcel()">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportToCsv()">
                        <i class="bi bi-file-earmark-text"></i> CSV
                    </a></li>
                </ul>
            `;
            header.insertBefore(exportGroup, header.firstChild);
        }
    },
    onFirstDataRendered: function(params) {
        const rowCount = params.api.getDisplayedRowCount();
        if (rowCount > 0) {
            setTimeout(() => {
                const columns = params.api.getAllDisplayedColumns();
                if (columns.length > 0) {
                    try {
                        const columnIds = columns.map(col => col.getColId());
                        params.api.autoSizeColumns(columnIds);
                    } catch (error) {
                        params.api.sizeColumnsToFit();
                    }
                }
                
                // Создаем кастомные хинты
                setTimeout(() => {
                    createCustomTooltips();
                }, 100);
            }, 200);
        }
    },

};

// Функции экспорта
function exportToExcel() {
    gridOptions.api.exportDataAsExcel({
        fileName: 'alarms_export.xlsx'
    });
}

function exportToCsv() {
    gridOptions.api.exportDataAsCsv({
        fileName: 'alarms_export.csv'
    });
}

// Инициализация AG Grid
document.addEventListener('DOMContentLoaded', function() {
    try {
        const gridDiv = document.querySelector('#alarmsGrid');
        agGrid.createGrid(gridDiv, gridOptions);
        
        // Debounce функция для оптимизации resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (gridOptions.api) {
                    // Обновляем конфигурацию столбцов
                    gridOptions.api.setColumnDefs(getColumnDefs());
                    
                    // Обновляем размеры таблицы
                    gridOptions.api.sizeColumnsToFit();
                    
                    setTimeout(() => {
                        const columnIds = gridOptions.api.getAllDisplayedColumns().map(col => col.getColId());
                        if (columnIds.length > 0) {
                            gridOptions.api.autoSizeColumns(columnIds);
                        }
                    }, 50);
                }
            }, 250);
        });
    } catch (error) {
        console.error('Ошибка инициализации AG Grid тревог:', error);
    }
});
</script>
{% endblock %}
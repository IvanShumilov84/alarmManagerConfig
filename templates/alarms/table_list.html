{% extends 'base.html' %}
{% load static %}

{% block title %}{% include 'alarms/includes/page_title.html' with page_title="Таблицы тревог" %}{% endblock %}

{% block extra_css %}
<!-- AG Grid CSS -->
<link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-grid.css">
<link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-theme-alpine.css">

<style>
    /* Контейнер для AG Grid */
    #tablesGrid {
        height: 600px;
        width: 100%;
    }
    
    /* Стили для кнопок действий */
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    
    .action-buttons .btn {
        padding: 2px 6px;
        font-size: 12px;
    }
    
    /* Стили для счетчика тревог */
    .alarms-count {
        font-weight: bold;
        color: #007bff;
    }
    
    /* Стили для описания */
    .table-description {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* Стили для дат */
    .date-cell {
        font-size: 12px;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-table me-2"></i>Таблицы тревог
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'alarms:table_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Создать таблицу
            </a>
        </div>
    </div>
</div>

<!-- Контейнер для AG Grid -->
<div id="tablesGrid" class="ag-theme-alpine"></div>

<!-- AG Grid JavaScript -->
<script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.js"></script>

<script>
// Данные для AG Grid
const tableData = [
    {% for table in tables %}
    {
        id: {{ table.id }},
        table_number: {{ table.table_number }},
        name: "{{ table.name|escapejs }}",
        description: "{{ table.description|escapejs }}",
        alarms_count: {{ table.alarms_count }},
        created_at: "{{ table.created_at|date:'Y-m-d H:i' }}",
        updated_at: "{{ table.updated_at|date:'Y-m-d H:i' }}",
        can_delete: {{ table.can_be_deleted|yesno:"true,false" }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Конфигурация колонок AG Grid
const columnDefs = [
    {
        headerName: 'ID',
        field: 'id',
        width: 80,
        sortable: true,
        filter: 'agNumberColumnFilter',
        pinned: 'left'
    },
    {
        headerName: 'Номер таблицы',
        field: 'table_number',
        width: 150,
        sortable: true,
        filter: 'agNumberColumnFilter',
        cellStyle: { fontWeight: 'bold' }
    },
    {
        headerName: 'Название',
        field: 'name',
        width: 200,
        sortable: true,
        filter: 'agTextColumnFilter',
        filterParams: {
            filterOptions: ['contains', 'startsWith', 'endsWith', 'equals']
        }
    },
    {
        headerName: 'Описание',
        field: 'description',
        width: 300,
        sortable: true,
        filter: 'agTextColumnFilter',
        cellRenderer: function(params) {
            if (params.value) {
                return `<div class="table-description" title="${params.value}">${params.value}</div>`;
            }
            return '<em class="text-muted">Не указано</em>';
        }
    },
    {
        headerName: 'Количество тревог',
        field: 'alarms_count',
        width: 150,
        sortable: true,
        filter: 'agNumberColumnFilter',
        cellRenderer: function(params) {
            return `<span class="alarms-count">${params.value}</span>`;
        }
    },
    {
        headerName: 'Дата создания',
        field: 'created_at',
        width: 150,
        sortable: true,
        filter: 'agDateColumnFilter',
        cellRenderer: function(params) {
            return `<div class="date-cell">${params.value}</div>`;
        }
    },
    {
        headerName: 'Дата обновления',
        field: 'updated_at',
        width: 150,
        sortable: true,
        filter: 'agDateColumnFilter',
        cellRenderer: function(params) {
            return `<div class="date-cell">${params.value}</div>`;
        }
    },
    {
        headerName: 'Действия',
        field: 'actions',
        width: 200,
        sortable: false,
        filter: false,
        cellRenderer: function(params) {
            const tableId = params.data.id;
            const canDelete = params.data.can_delete;
            
            let deleteButton = '';
            if (canDelete) {
                deleteButton = `
                    <a href="/alarms/tables/${tableId}/delete/" class="btn btn-sm btn-outline-danger" title="Удалить">
                        <i class="bi bi-trash"></i>
                    </a>
                `;
            } else {
                deleteButton = `
                    <button class="btn btn-sm btn-outline-secondary" disabled title="Нельзя удалить (есть тревоги)">
                        <i class="bi bi-trash"></i>
                    </button>
                `;
            }
            
            return `
                <div class="action-buttons">
                    <a href="/alarms/tables/${tableId}/" class="btn btn-sm btn-outline-info" title="Просмотр">
                        <i class="bi bi-eye"></i>
                    </a>
                    <a href="/alarms/tables/${tableId}/edit/" class="btn btn-sm btn-outline-primary" title="Редактировать">
                        <i class="bi bi-pencil"></i>
                    </a>
                    ${deleteButton}
                </div>
            `;
        }
    }
];

// Конфигурация AG Grid
const gridOptions = {
    columnDefs: columnDefs,
    rowData: tableData,
    
    // Основные настройки
    defaultColDef: {
        sortable: true,
        filter: true,
        resizable: true,
        minWidth: 100
    },
    
    // Пагинация
    pagination: true,
    paginationPageSize: 20,
    paginationPageSizeSelector: [10, 20, 50, 100],
    
    // Сортировка
    multiSortKey: 'ctrl',
    
    // Выбор строк
    rowSelection: 'multiple',
    
    // Экспорт
    enableRangeSelection: true,
    
    // Производительность
    animateRows: true,
    
    // События
    onGridReady: function(params) {
        // Автоматически подгоняем размер колонок под содержимое
        params.api.sizeColumnsToFit();
        
        // Загружаем сохраненные настройки
        loadGridSettings();
    },
    
    onSortChanged: function(event) {
        saveGridSettings();
    },
    
    onFilterChanged: function(event) {
        saveGridSettings();
    },
    
    onColumnMoved: function(event) {
        saveGridSettings();
    },
    
    onColumnResized: function(event) {
        saveGridSettings();
    }
};

// Функции для работы с настройками
function saveGridSettings() {
    const settings = {
        columnState: gridOptions.api.getColumnState(),
        sortModel: gridOptions.api.getSortModel(),
        filterModel: gridOptions.api.getFilterModel()
    };
    localStorage.setItem('tablesGridSettings', JSON.stringify(settings));
}

function loadGridSettings() {
    const saved = localStorage.getItem('tablesGridSettings');
    if (saved) {
        try {
            const settings = JSON.parse(saved);
            
            if (settings.columnState) {
                gridOptions.api.applyColumnState({
                    state: settings.columnState,
                    applyOrder: true
                });
            }
            
            if (settings.sortModel) {
                gridOptions.api.setSortModel(settings.sortModel);
            }
            
            if (settings.filterModel) {
                gridOptions.api.setFilterModel(settings.filterModel);
            }
        } catch (error) {
            console.error('Ошибка загрузки настроек:', error);
        }
    }
}

// Инициализация AG Grid
document.addEventListener('DOMContentLoaded', function() {
    const gridDiv = document.querySelector('#tablesGrid');
    new agGrid.Grid(gridDiv, gridOptions);
});

// Функции экспорта
function exportToExcel() {
    gridOptions.api.exportDataAsExcel({
        fileName: 'tables_export.xlsx'
    });
}

function exportToCsv() {
    gridOptions.api.exportDataAsCsv({
        fileName: 'tables_export.csv'
    });
}

// Добавляем кнопки экспорта в заголовок
document.addEventListener('DOMContentLoaded', function() {
    const header = document.querySelector('.btn-toolbar');
    const exportGroup = document.createElement('div');
    exportGroup.className = 'btn-group me-2';
    exportGroup.innerHTML = `
        <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown">
            <i class="bi bi-download"></i> Экспорт
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exportToExcel()">
                <i class="bi bi-file-earmark-excel"></i> Excel
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="exportToCsv()">
                <i class="bi bi-file-earmark-text"></i> CSV
            </a></li>
        </ul>
    `;
    header.insertBefore(exportGroup, header.firstChild);
});
</script>
{% endblock %} 
